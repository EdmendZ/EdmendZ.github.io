<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>OpenGL Advance | TryhardZhang Blog</title><meta name="keywords" content="OpenGL,Graphics"><meta name="author" content="Edmend Zhang"><meta name="copyright" content="Edmend Zhang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="OpenGL Advance"><meta name="application-name" content="OpenGL Advance"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="OpenGL Advance"><meta property="og:url" content="http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/index.html"><meta property="og:site_name" content="TryhardZhang Blog"><meta property="og:description" content="OpenGL Advance - Graphics"><meta property="og:locale" content="en"><meta property="og:image" content="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/4d7108d8db204bfbaabe41ffc07cf1cd.png?_r_=fba0f37a-4bbe-3123-e309-13693001d871"><meta property="article:author" content="Edmend Zhang"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/4d7108d8db204bfbaabe41ffc07cf1cd.png?_r_=fba0f37a-4bbe-3123-e309-13693001d871"><meta name="description" content="OpenGL Advance - Graphics"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: 'https://tryhardzhang.netlify.app/.netlify/functions/twikoo',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: {"apiurl":null},
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 游戏数码爱好者","🔍 分享与热心帮助","🏠 桌游剧本杀玩家","🔨 设计开发一条龙","🤝 游戏设计图形学","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"9TNSMQ05C5","apiKey":"4163bfe8549a994a4e63041853630d66","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"Author: Edmend Zhang","link":"Link: ","source":"Source: TryhardZhang Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.","copySuccess":"Copy success, copy and reprint please mark the address of this article"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'TryhardZhang Blog',
  title: 'OpenGL Advance',
  postAI: '',
  pageFillDescription: 'OpenGL Advance, 深度测试, 深度值推导, 模板缓存, 高光边缘（选中效果）原理, Blending 效果, 透明的原理, 接口, 第一步计算出源颜色与目标颜色, 第二步设置计算后的SRC颜色与DST颜色之间的计算方式, cullFace表面剔除, 定义面的顶点绘制顺序, 接口, FramBuffer 帧缓存, 创建帧缓存, 原则, Texture 作为Buffer附件ColorBuffer, RenderBuffer作为Buffer附件ColorBuffer, 创建RenderBuffer, FrameBuffer 渲染流程, CubeMap, CubeMap接口, 天空盒理论, 天空盒Shader解析, VertexShader, FragmentShader, 天空盒优化, 问题, 优化, 环境贴图, 反射, Shader, 折射, 数据接口, 定点数据拷贝, glMapBuffer 虚拟指针, 顶点数据打包方式, buffer之间的数据拷贝, 内置变量, 接口数据块 Blocks, UniformBlock 显存分配, 全局数据块 Uniform Buffer Object, **shared 默认方式 **, std140, UBO 生成过程, core code 省略后, GeometryShader 几何着色器, 几何着色器原理, 点输入, 三角形输入, Geometry 输出 重新定义了图元装配的类型, GeometryShader, gl_in, 法向量可视化, VertexShader, GeometryShader, 模型读取, 模型材质, Assimp库（读取）, Scene, Child node, Mesh, DrawCall 减少性能开销, gl_InstanceID 内置变量, gl_InstanceID 内置变量 优化 InstanceArray, glVertexAttribDivisor(GLuint index GLuint divisor), Instance 实现, Blin-Phong 光照实现, 半程向量, 实现效果, Gamma矫正, 显示器亮度与电压的关系, SRGB颜色空间, ShadowMapping, 平行光, 深度渲染 FrameBuffer, FragmentShader 阴影部分（Pass2）, 实际效果, ShadowAnce 噪声 （采样不均问题）, Bias参数去噪, Peter Panning 去噪, 过采样问题, 阴影锯齿问题, PCF-percentage-closer filtering, PointShadow, 优化思路, 阴影渲染流程, CubeMap坐标原理, 法线贴图 amp TBN空间推导, TBN 空间转换, HDR颜色空间, HDR-FloatingPoint Buffers, HDR toneMapping, Reinhard tone mapping, Exposure tone mapping, Bloom 效果, Bloom 基础做法, 光源边界问题界定, MRT技术, 实现效果, 高斯模糊, 高斯 Shader, 延迟渲染技术, G缓冲, 正向渲染中照亮一个片段所需要的所有数据, 延迟光照处理, Shader, 结合延迟渲染与正向渲染, 光的体积渲染, Threshold 边界, 程序流程, 优化, 光源重合问题, CullFace问题深度测试开启深度测试每次清空深度缓存设定深度缓存对比函数深度值推导模板缓存允许模板缓存写入数据禁止模板缓存写入数据参数什么情况下通过模板测试参数对比的数据对象参数对比之前缓存内数据与对比数据都要跟它做一次与操作在模板测试之后根据不同的测试情况做出不同反应如果本模板测试没通过怎么做如果本模板测试通过深度测试没通过怎么做如果本模板测试跟深度测试都通过了怎么做高光边缘选中效果原理传入物体材质属性绘制方盒绘制高光边缘渲染高光边缘绘制太阳效果透明的原理格式这个值即定义本色块在与当中的颜色产生混合的时候所占有的比例颜色混合公式要绘制的物体本的像素颜色值要绘制的物体本的值里面目标点的颜色值接口第一步计算出源颜色与目标颜色第二步设置计算后的颜色与颜色之间的计算方式数据绘制地面绘制方盒绘制窗体为了避免深度缓存的问题我们根据相机的距离先绘制最远的窗体表面剔除解决多余的绘制定义面的顶点绘制顺序接口也可以是定义正面是顺时针还是逆时针逆时针方向为正面方向顺时针为正帧缓存帧缓存不是指一块显存而是类似于的一个组织结构他里面包含了很多附件附件里面会根据不同需求开辟不同的显存空间长期以来我们都是用默认的帧缓存来做渲染默认的是号帧缓存创建一个属于我们自己的额外的帧缓存并且利用它来做后处理这种渲染方式为离屏渲染创建帧缓存创建帧缓存的方式跟等一样接下来进行附件的创建与绑定操作恢复原始的默认没用了可以删除原则帧缓存需要至少绑定一个附件至少有一个绑定每个绑定的附件必须都开辟内存完毕每个绑定的附件必须都有相同的采样标准个像素数据信息作为附件创建创建作为附件创建作为作为渲染流程坐标表示纹理坐标系中沿水平轴轴的坐标坐标表示纹理坐标系中沿垂直轴轴的坐标坐标表示与立方体面法线方向相关的深度坐标轴接口天空盒理论设置一个正方体每个方向的取值范围是到并且质心位于坐标原点做一个的并且为六个面都设置目标贴图在正方体当中把坐标直接传给插值后的结果并且去掉摄像机矩阵对于平移的影响在当中利用坐标来做坐标采样给到但是每次都必须先绘制天空盒天空盒解析直接用物理坐标给纹理坐标赋值天空盒优化问题每次都需要优先绘制天空盒天空盒铺满整个屏幕所以对于性能还是有一定的损耗如何能够将天空盒的深度都做到最深呢优化变量在每次设置的时候都是非坐标他跟之间唯一的差距在于还没有对除以值在绘制天空盒的时候将变量设置为就会在下一阶段计算深度值得时候用当前的除以即直接得到即最大深度环境贴图反射折射数据接口定点数据拷贝向中进行定点数据拷贝进行不同的数据打包方式在不同的之间拷贝数据拷贝的数据指针多次修改数据会造成性能上的浪费每次从内存将数据拷贝到显存虚拟指针顶点数据打包方式之间的数据拷贝从开始读从开始写数据大小内置变量继续渲染丢弃接口数据块显存分配全局数据块变量在显存重点存储方式默认方式生成过程先绑定然后根据绑定两种绑定方式直接绑定绑定范围里有的的生命可以进行绑定省略后数据填充绘制方盒绘制方盒几何着色器几何着色器原理几何着色器对装配的顶点进行生成或减除操作重新定义图元的类型点输入三角形输入每三个一组创建一个将变量放到中输送给输出重新定义了图元装配的类型剪裁距离法向量可视化正常渲染模型使用方式渲染模型得到法向量模型读取模型材质库读取场景根节点模型顶点信息综合模型贴图信息部分模型信息模型块包含构建模型块的所有顶点信息坐标法线索引纹理等模型块数据结构函数构造函数设置函数绘制函数拼装传参字符串位置信息读取法线纹理坐标解析解析材质解析骨骼动画给顶点权重及骨骼解析骨骼构建骨骼减少性能开销使用来做统一将所有渲染任务压入一次性打包绘制的实例数量内置变量代表正在绘制的实例编号从开始依次递增使用会导致过多的使用变量内置变量优化利用顶点数组进行书传书中使用进行的获取挂载锚点绑定数据最多支持所以拆开挂载的锚点多少个实例迭代一次代表一个顶点迭代一次代表一个模型实例绘制迭代一次实现光照设置准备模型变换矩阵光照实现半程向量反射光和人眼的夹角大于九十度导致光线被计算忽略造成偏差实现效果矫正显示器亮度与电压的关系显示器是通过电压对屏幕亮度进行调节但是电压的增长与亮度的增长并不是线性相关的关系大概会是一个次幂的关系现代的显示器为了兼容也做了一些类似的设置保留所以如果想显示真实场景就需要校正颜色空间经过校正后的颜色所构成的颜色空间即为颜色空间颜色那么这个即为颜色空间当中的颜色值了伽马矫正启用方式函数调用后会再每一个产生出来的颜色中使用一次矫正将颜色转为颜色空间的色彩输出到显示器及进行类似幂运算直接再当中手动加上矫正再美术工作中如果工具软件具有矫正会输出颜色空间的贴图程序解读后进行矫正会导致效果和美术生成所看到的效果不同创作者做一次次幂美术操作次幂之后正常程序读入做一次次幂做一次次幂做一次次幂正常使用纹理图片之前做一次到的转换然后再做后续可以如此接口使用在图片读进来的时候就设置为空间然后会被自动转化为次幂之后就可以使用场景变得柔和平行光深度渲染阴影部分对应找到各个点深度值得到转化为到为为是否产生阴影所渲染物体在光源空间的坐标类除成为实际效果噪声采样不均问题深度差别太小导致通过测试未通过测试亮暗明暗交替参数去噪同样但也会导致之前该是阴影的部分抬升去噪过采样问题超出立方体的点处理方式使用的过采样方式让出界的都采样到的深度阴影锯齿问题深度贴图分辨率有限采样密度不够最简单的方式多顶当前要处理的对应的深度贴图使用周围八个进行平均单一光源方向并不足够房间中的光照需要优化每个面对应一个度的视场角覆盖场景的一个特定方向前后左右上下每个面都可以使用一个标准的透视投影矩阵进行渲染通常设置为度以确保没有任何失真或间隙首先可以想到为光源的个方向做个光照矩阵次渲染得到张深度贴图进行优化思路问题描述我们需要渲染六张图为什么必须要做六次渲染流程呢主要是每次都需要虚拟一个光照矩阵然后这六个光照矩阵分别跟相乘做变换分别渲染设想对每个三角形来讲有没有可能通过一次流程传入六个光照矩阵对每个三角形进行六次变换输出六个三角形解决可以通过可以将一个三角形输入做成个三角形图源输出给问题描述我们在里拿到了六个三角形的数据分别对应六个光照矩阵以及六个阴影深度贴图那么我们如何指定哪个三角形渲染到哪个贴图呢结论在里有一个内置变量叫做它可以在里配合每个输出的图元三角形指定输送给编号为几的但是只能对这种类型管用问题描述我现在手里有六个面的六张深度贴图当我进行真正渲染的时候需要知道哪个到底去哪个贴图里读取深度一般是跟光线连线然后看看指向哪个面太复杂了结论对于六个面取纹理这个问题就很好地解决了呀将光源与当前需要渲染的位置连一条向量用这个向量直接作为坐标对进行采样即可阴影渲染流程坐标原理在二维图像纹理中如果直接读入一张图显示会出现上下翻转图片的在左上角的在左下角读入图片生成纹理之前需要在反向做翻转在中并没有上下翻转有一个向量如果使用这个向当前的进行采样那么是如何被翻译到某一个的上面呢首先我们看下在的每个分量当中绝对值最大的是哪个比如是绝对值最大并且还是正数那就说明要冲这个进行取值计算坐标此时由于冲着正方向那么一横一竖但是这里就有问题了法线贴图空间推导如何做出物体表面凹凸不平的效果真实的物体表面应该是粗糙的几乎每一个之间的法线都会有所不同把一张法线贴图做成一个以为点为原点的笛卡尔坐标系指向外部的向量为每个各自的法向量按照右手坐标系法则求剩下的值如果看作坐标系轴为轴为轴每一个法线都可以是坐标系中的向量空间转换我们目前做出来了一组切线空间的正交基目前存在两个选择在每一个的执行周期将每一个法线贴图的转换到世界坐标系将每一个相关变量都转换到坐标空间然后与法线贴图的进行计算颜色空间系统会把超过的颜色切位如果颜色大于的过多就会过度曝光如果场景当中有很多灯光且彼此差距很大那么很容易造成某些亮度过高我们有两个处理方式调整场景当中光源的强度使得大部分的颜色值不会超过但是会让场景无法表达本来的信息允许场景当中存在超过的颜色值但是在最后输出颜色的时候做统一的转换计算转换到从而能够更大程度的保持场景当中的颜色信息颜色空间方式允许颜色值大于的存在最早用于摄影的曝光拍摄通过更多的接受光照从而能够揭示出来光照较少部分的细节此时我们假设渲染到某个上面为的建立通道这里对于一个像素的值每个通道使用一个存储并且每个分量占有即字节当然如果我们精度要求很高可以使用即一个通道位字节将颜色从颜色空间转到颜色空间的过程称为如果简单的把空间的颜色线性的映射到空间根本不会有任何的意义反而光线暗的地方更加看不到了我们必须要用其他的变换公式来进行二者之间的映射效果基础做法将场景渲染出来到的将灯光单独抠图出来渲染到的将灯光单独做模糊将灯光图合并到主场景中光源边界问题界定我们如何界定当中哪些像素是代表着光源呢如果我们认定大于某个值为光源那么万一遇到白色物体如何决定解决在渲染的时候使用颜色空间就可以将光源设置成为大于的颜色值使得光源颜色与其它物体颜色差距变大技术如何一个完成两个任务将场景渲染到将灯光渲染到并且希望使用同一个解决使用技术即在当中存在多个选项我们可以启动两个附件在当中对这两个目标进行渲染将两个绘制目标绑定到的两个锚定位置实现效果高斯模糊拆分降低复杂度高斯延迟渲染技术缓冲缓冲是对所有用来储存光照相关的数据并在最后的光照处理阶段中使用的所有纹理的总称正向渲染中照亮一个片段所需要的所有数据一个位置向量来计算插值片段位置变量供和使用一个漫反射颜色向量也就是反照率一个法向量来判断平面的斜率一个镜面强度浮点值所有光源的位置和颜色向量玩家或者观察者的位置向量正向渲染或者正向着色法它是我们渲染物体的一种非常直接的方式在场景中我们根据所有光源照亮一个物体之后再渲染下一个物体以此类推它非常容易理解也很容易实现但是同时它对程序性能的影响也很大因为对于每一个需要渲染的物体程序都要对每一个光源每一个需要渲染的片段进行迭代这是非常多的因为大部分片段着色器的输出都会被之后的输出覆盖正向渲染还会在场景中因为高深的复杂度多个物体重合在一个像素上浪费大量的片段着色器运行时间延迟着色法或者说是延迟渲染为了解决上述问题而诞生了它大幅度地改变了我们渲染物体的方式这给我们优化拥有大量光源的场景提供了很多的选择因为它能够在渲染上百甚至上千光源的同时还能够保持能让人接受的帧率延迟或推迟大部分计算量非常大的渲染像是光照到后期进行处理的想法它包含两个处理阶段在第一个几何处理阶段中我们先渲染场景一次之后获取对象的各种几何信息并储存在一系列叫做缓冲的纹理中想想位置向量颜色向量法向量和或镜面值场景中这些储存在缓冲中的几何信息将会在之后用来做更复杂的光照计算保证在缓冲中的片段和在屏幕上呈现的像素所包含的片段信息是一样的因为深度测试已经最终将这里的片段信息作为最顶层的片段这样保证了对于在光照处理阶段中处理的每一个像素都只处理一次所以我们能够省下很多无用的渲染调用除此之外延迟渲染还允许我们做更多的优化从而渲染更多的光源游戏循环几何处理阶段渲染所有的几何颜色数据到缓冲光照处理阶段使用缓冲计算场景的光照对于几何渲染处理阶段我们首先需要初始化一个帧缓冲对象我们很直观的称它为它包含了多个颜色缓冲和一个单独的深度渲染缓冲对象对于位置和法向量的纹理我们希望使用高精度的纹理每分量或位的浮点数而对于反照率和镜面值使用默认的纹理每分量位浮点数就够了位置颜色缓冲法线颜色缓冲颜色镜面颜色缓冲告诉我们将要使用帧缓冲的哪种颜色附件来进行渲染延迟光照处理现在我们已经有了一大堆的片段数据储存在缓冲中供我们处置我们可以选择通过一个像素一个像素地遍历各个缓冲纹理并将储存在它们里面的内容作为光照算法的输入来完全计算场景最终的光照颜色由于所有的缓冲纹理都代表的是最终变换的片段值我们只需要对每一个像素执行一次昂贵的光照运算就行了这使得延迟光照非常高效特别是在需要调用大量重型片段着色器的复杂场景中同样发送光照相关的在渲染之前绑定了缓冲中所有相关的纹理并且发送光照相关的变量到着色器中从缓冲中获取数据然后和往常一样地计算光照硬编码环境光照分量漫反射结合延迟渲染与正向渲染在延迟渲染方形之上正向渲染所有的光源正常情况下渲染立方体只是会在我们完成延迟渲染操作之后进行首先复制出在几何渲染阶段中储存的深度信息并输出到默认的帧缓冲的深度缓冲然后我们才渲染光立方体这样之后只有当它在之前渲染过的几何体上方的时候光立方体的片段才会被渲染出来我们可以使用复制一个帧缓冲的内容到另一个帧缓冲中用来还原多重采样的帧缓冲这个函数允许我们复制一个用户定义的帧缓冲区域到另一个用户定义的帧缓冲区域光的体积渲染问题如果场景当中存在多个光源那么即便是使用延迟渲染那么也会出现每个跟每个光产生一次渲染的性能问题我们能不能对每个光源的辐射范围做一个判断如果当前的不在范围内就不去计算边界问题对于每个光源如果距离计算衰减到光照为就表示不用去计算的话就不会找到边界了想法我们可以设置一个阈值用如下公式计算距离如果大于的就忽略掉延迟渲染它本身并不能支持非常大量的光源因为我们仍然必须要对场景中每一个光源计算每一个片段的光照分量真正让大量光源成为可能的是我们能够对延迟渲染管线引用的一个非常棒的优化光体积得出即为的阈值程序流程再运行的时候并行执行会造成性能丢失优化将所有的几何信息写在上面也就是说我们可以为每一个光照做一个球然后使用的信息作为绑定纹理只渲染每一个光照球这个球体范围内的才会被渲染光源重合问题使用功能设置混合模式比如我们可以设置对物体影响最强的光源为主也可以采用相加方式问题球体存在正反两面所以会被绘制两次增大了负担会导致进入球体内部不存在渲染开启绘制效率且可以进入球体内部只对球体背面进行绘制这样提高了一倍的',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-18 06:52:24',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_imageava.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">TryhardZhang Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 想法</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=9570676565&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> Search</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> Newest Comments</span></div><div class="aside-list"><span>loading...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CPP/" style="font-size: 1.05rem;">CPP<sup>2</sup></a><a href="/tags/CSEN-279/" style="font-size: 1.05rem;">CSEN 279<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>2</sup></a><a href="/tags/FFMPEG/" style="font-size: 1.05rem;">FFMPEG<sup>3</sup></a><a href="/tags/Frigate/" style="font-size: 1.05rem;">Frigate<sup>1</sup></a><a href="/tags/Games101/" style="font-size: 1.05rem;">Games101<sup>9</sup></a><a href="/tags/Graphics/" style="font-size: 1.05rem;">Graphics<sup>12</sup></a><a href="/tags/Home-Assistant/" style="font-size: 1.05rem;">Home Assistant<sup>1</sup></a><a href="/tags/HomeAssistant/" style="font-size: 1.05rem;">HomeAssistant<sup>1</sup></a><a href="/tags/Interview-Question/" style="font-size: 1.05rem;">Interview Question<sup>1</sup></a><a href="/tags/OpenGL/" style="font-size: 1.05rem;">OpenGL<sup>3</sup></a><a href="/tags/RTMP/" style="font-size: 1.05rem;">RTMP<sup>1</sup></a><a href="/tags/RTP/" style="font-size: 1.05rem;">RTP<sup>1</sup></a><a href="/tags/RTSP/" style="font-size: 1.05rem;">RTSP<sup>4</sup></a><a href="/tags/SDL/" style="font-size: 1.05rem;">SDL<sup>1</sup></a><a href="/tags/UE5/" style="font-size: 1.05rem;">UE5<sup>3</sup></a><a href="/tags/VCPKG/" style="font-size: 1.05rem;">VCPKG<sup>1</sup></a><a href="/tags/csen-272/" style="font-size: 1.05rem;">csen 272<sup>2</sup></a><a href="/tags/live555/" style="font-size: 1.05rem;">live555<sup>1</sup></a><a href="/tags/nlp/" style="font-size: 1.05rem;">nlp<sup>2</sup></a><a href="/tags/search/" style="font-size: 1.05rem;">search<sup>2</sup></a><a href="/tags/%E5%85%A8%E6%99%AF%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 1.05rem;">全景播放器<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem;">博客<sup>1</sup></a><a href="/tags/%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 1.05rem;">播放器<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 1.05rem;">虚拟机<sup>1</sup></a><a href="/tags/%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 1.05rem;">视频播放器<sup>1</sup></a><a href="/tags/%E8%A7%86%E9%A2%91%E6%B5%81%E4%BC%A0%E8%BE%93/" style="font-size: 1.05rem;">视频流传输<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>Archives</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">August 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">14</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">March 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">August 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">July 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">22</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">April 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">March 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Graphics/" itemprop="url">Graphics</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/OpenGL/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>OpenGL</span></a><a class="article-meta__tags" href="/tags/Graphics/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Graphics</span></a></span></div></div><h1 class="post-title" itemprop="name headline">OpenGL Advance</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-08-18T06:52:24.917Z" title="Created 2025-08-18 06:52:24">2025-08-18</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-18T06:52:24.917Z" title="Updated 2025-08-18 06:52:24">2025-08-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span id="" data-flag-title="OpenGL Advance"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">Post View:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为Shanghai"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>Shanghai</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/4d7108d8db204bfbaabe41ffc07cf1cd.png?_r_=fba0f37a-4bbe-3123-e309-13693001d871"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/"><header><a class="post-meta-categories" href="/categories/Graphics/" itemprop="url">Graphics</a><a href="/tags/OpenGL/" tabindex="-1" itemprop="url">OpenGL</a><a href="/tags/Graphics/" tabindex="-1" itemprop="url">Graphics</a><h1 id="CrawlerTitle" itemprop="name headline">OpenGL Advance</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Edmend Zhang</span><time itemprop="dateCreated datePublished" datetime="2025-08-18T06:52:24.917Z" title="Created 2025-08-18 06:52:24">2025-08-18</time><time itemprop="dateCreated datePublished" datetime="2025-08-18T06:52:24.917Z" title="Updated 2025-08-18 06:52:24">2025-08-18</time></header><h1 id="OpenGL-Advance"><a href="#OpenGL-Advance" class="headerlink" title="OpenGL Advance"></a>OpenGL Advance</h1><h2 id="深度测试"><a href="#深度测试" class="headerlink" title="深度测试"></a>深度测试</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805105725325.png" alt="image-20240805105725325" style="zoom:67%;" />

<p>开启深度测试<br>glEnable(GL_DEPTH_TEST);</p>
<p>每次清空深度缓存<br>glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</p>
<p>设定深度缓存对比函数<br>glDepthFunc(GL_LESS);</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805110153360.png" alt="image-20240805110153360" style="zoom:67%;" />

<h3 id="深度值推导"><a href="#深度值推导" class="headerlink" title="深度值推导"></a>深度值推导</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805110451436.png" alt="image-20240805110451436" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805111959130.png" alt="image-20240805111959130" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805113424885.png" alt="image-20240805113424885" style="zoom:67%;" />

<h3 id="模板缓存"><a href="#模板缓存" class="headerlink" title="模板缓存"></a>模板缓存</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805113950797.png" alt="image-20240805113950797" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805114233315.png" alt="image-20240805114233315" style="zoom:67%;" />

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glEnable</span>(GL_STENCIL_TEST);</span><br><span class="line"><span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glStencilMask</span>(OxFF);允许模板缓存写入数据</span><br><span class="line"><span class="built_in">glStencilMask</span>(<span class="number">0x00</span>);禁止模板缓存写入数据</span><br><span class="line"><span class="built_in">glStencilFunc</span>(GL_EQUAL, <span class="number">1</span>, <span class="number">0xFF</span>)</span><br><span class="line">参数<span class="number">1</span>:什么情况下通过模板测试GL_NEVER,GL_LESS, GL_LEQUAL, GL_GREATER,</span><br><span class="line">GL_GEQUAL, GL_EQUAL, GL_NOTEQUAL, GL_ALWAYS</span><br><span class="line">参数<span class="number">2</span>:对比的数据对象</span><br><span class="line">参数<span class="number">3</span>:对比之前,缓存内数据与对比数据都要跟它做一次与操作</span><br><span class="line"></span><br><span class="line"><span class="built_in">glStencilOp</span>(GLenum sfail, GLenum dpfail, GLenum dppass)</span><br><span class="line">在模板测试之后,根据不同的测试情况,做出不同反应</span><br><span class="line">sfail:如果本Fragment模板测试没通过,怎么做</span><br><span class="line">dpfail:如果本Fragment模板测试通过,深度测试没通过,怎么做</span><br><span class="line">dppass:如果本Fragment模板测试跟深度测试都通过了,怎么做</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805120819073.png" alt="image-20240805120819073" style="zoom:67%;" />

<h3 id="高光边缘（选中效果）原理"><a href="#高光边缘（选中效果）原理" class="headerlink" title="高光边缘（选中效果）原理"></a>高光边缘（选中效果）原理</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805122519342.png" alt="image-20240805122519342" style="zoom:67%;" />

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_STENCIL_TEST);</span><br><span class="line">    <span class="built_in">glStencilMask</span>(<span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glClearColor</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    glm::vec3 cubePositions[] = &#123;</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>,  <span class="number">0.0f</span>,  <span class="number">0.0f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">2.0f</span>,  <span class="number">5.0f</span>, <span class="number">-15.0f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">-1.5f</span>, <span class="number">-2.2f</span>, <span class="number">-2.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">-3.8f</span>, <span class="number">-2.0f</span>, <span class="number">-12.3f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">2.4f</span>, <span class="number">-0.4f</span>, <span class="number">-3.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">-1.7f</span>,  <span class="number">3.0f</span>, <span class="number">-7.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">1.3f</span>, <span class="number">-2.0f</span>, <span class="number">-2.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">1.5f</span>,  <span class="number">2.0f</span>, <span class="number">-2.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">1.5f</span>,  <span class="number">0.2f</span>, <span class="number">-1.5f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">-1.3f</span>,  <span class="number">1.0f</span>, <span class="number">-1.5f</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    glm::vec3 pointLightPositions[] = &#123;</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">0.7f</span>,  <span class="number">0.2f</span>,  <span class="number">2.0f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">2.3f</span>, <span class="number">-3.3f</span>, <span class="number">-4.0f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">-4.0f</span>,  <span class="number">2.0f</span>, <span class="number">-12.0f</span>),</span><br><span class="line">    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>,  <span class="number">0.0f</span>, <span class="number">-3.0f</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _camera.<span class="built_in">update</span>();</span><br><span class="line">    _projMatrix = glm::<span class="built_in">perspective</span>(glm::<span class="built_in">radians</span>(<span class="number">45.0f</span>), (<span class="type">float</span>)_width / (<span class="type">float</span>)_height, <span class="number">0.1f</span>, <span class="number">100.0f</span>);</span><br><span class="line">    glm::mat4 _modelMatrix(<span class="number">1.0f</span>);</span><br><span class="line">    _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-3.0f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glActiveTexture</span>(GL_TEXTURE0);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _textureBox);</span><br><span class="line">    <span class="built_in">glActiveTexture</span>(GL_TEXTURE1);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _textureSpec);</span><br><span class="line"></span><br><span class="line">    _shader_scene.<span class="built_in">start</span>();</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;view_pos&quot;</span>, _camera.<span class="built_in">getPosition</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//传入物体材质属性</span></span><br><span class="line">    _shader_scene.<span class="built_in">setInt</span>(<span class="string">&quot;myMaterial.m_specular&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;myMaterial.m_shiness&quot;</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    _shader_scene.<span class="built_in">setMatrix</span>(<span class="string">&quot;_viewMatrix&quot;</span>, _camera.<span class="built_in">getMatrix</span>());</span><br><span class="line">    _shader_scene.<span class="built_in">setMatrix</span>(<span class="string">&quot;_projMatrix&quot;</span>, _projMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// directional light</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_dirLight.m_direction&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">-0.2f</span>, <span class="number">-1.0f</span>, <span class="number">-0.3f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_dirLight.m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.05f</span>, <span class="number">0.05f</span>, <span class="number">0.05f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_dirLight.m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.4f</span>, <span class="number">0.4f</span>, <span class="number">0.4f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_dirLight.m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>));</span><br><span class="line">    <span class="comment">// point light 1</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[0].m_pos&quot;</span>, pointLightPositions[<span class="number">0</span>]);</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[0].m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.05f</span>, <span class="number">0.05f</span>, <span class="number">0.05f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[0].m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.8f</span>, <span class="number">0.8f</span>, <span class="number">0.8f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[0].m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[0].m_c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[0].m_l&quot;</span>, <span class="number">0.09</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[0].m_q&quot;</span>, <span class="number">0.032</span>);</span><br><span class="line">    <span class="comment">// point light 2</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[1].m_pos&quot;</span>, pointLightPositions[<span class="number">1</span>]);</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[1].m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.05f</span>, <span class="number">0.05f</span>, <span class="number">0.05f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[1].m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.8f</span>, <span class="number">0.8f</span>, <span class="number">0.8f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[1].m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[1].m_c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[1].m_l&quot;</span>, <span class="number">0.09</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[1].m_q&quot;</span>, <span class="number">0.032</span>);</span><br><span class="line">    <span class="comment">// point light 3</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[2].m_pos&quot;</span>, pointLightPositions[<span class="number">2</span>]);</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[2].m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.05f</span>, <span class="number">0.05f</span>, <span class="number">0.05f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[2].m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.8f</span>, <span class="number">0.8f</span>, <span class="number">0.8f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[2].m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[2].m_c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[2].m_l&quot;</span>, <span class="number">0.09</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[2].m_q&quot;</span>, <span class="number">0.032</span>);</span><br><span class="line">    <span class="comment">// point light 4</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[3].m_pos&quot;</span>, pointLightPositions[<span class="number">3</span>]);</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[3].m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.05f</span>, <span class="number">0.05f</span>, <span class="number">0.05f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[3].m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.8f</span>, <span class="number">0.8f</span>, <span class="number">0.8f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_pointLight[3].m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[3].m_c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[3].m_l&quot;</span>, <span class="number">0.09</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_pointLight[3].m_q&quot;</span>, <span class="number">0.032</span>);</span><br><span class="line">    <span class="comment">// spotLight</span></span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_spotLight.m_pos&quot;</span>, _camera.<span class="built_in">getPosition</span>());</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_spotLight.m_direction&quot;</span>, _camera.<span class="built_in">getDirection</span>());</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_spotLight.m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_spotLight.m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setVec3</span>(<span class="string">&quot;_spotLight.m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_spotLight.m_c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_spotLight.m_l&quot;</span>, <span class="number">0.09</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_spotLight.m_q&quot;</span>, <span class="number">0.032</span>);</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_spotLight.m_cutOff&quot;</span>, glm::<span class="built_in">cos</span>(glm::<span class="built_in">radians</span>(<span class="number">12.5f</span>)));</span><br><span class="line">    _shader_scene.<span class="built_in">setFloat</span>(<span class="string">&quot;_spotLight.m_outCutOff&quot;</span>, glm::<span class="built_in">cos</span>(glm::<span class="built_in">radians</span>(<span class="number">15.0f</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//////绘制方盒</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">glStencilFunc</span>(GL_ALWAYS, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">        <span class="built_in">glStencilMask</span>(<span class="number">0x00</span>);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">glStencilFunc</span>(GL_ALWAYS, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">            <span class="built_in">glStencilMask</span>(<span class="number">0xFF</span>);</span><br><span class="line">            <span class="built_in">glStencilOp</span>(GL_KEEP, GL_KEEP, GL_REPLACE);</span><br><span class="line">        &#125;</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, cubePositions[i]);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">rotate</span>(_modelMatrix, glm::<span class="built_in">radians</span>(i * <span class="number">20.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));Fre</span><br><span class="line"></span><br><span class="line">        _shader_scene.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(VAO_cube);</span><br><span class="line">        <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _shader_scene.<span class="built_in">end</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制高光边缘</span></span><br><span class="line">    _shader_color.<span class="built_in">start</span>();</span><br><span class="line">    _shader_color.<span class="built_in">setMatrix</span>(<span class="string">&quot;_viewMatrix&quot;</span>, _camera.<span class="built_in">getMatrix</span>());</span><br><span class="line">    _shader_color.<span class="built_in">setMatrix</span>(<span class="string">&quot;_projMatrix&quot;</span>, _projMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//////渲染高光边缘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">glStencilFunc</span>(GL_NEVER, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">        <span class="built_in">glStencilMask</span>(<span class="number">0x00</span>);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">glStencilFunc</span>(GL_NOTEQUAL, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, cubePositions[i]);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">rotate</span>(_modelMatrix, glm::<span class="built_in">radians</span>(i * <span class="number">20.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">scale</span>(_modelMatrix, glm::<span class="built_in">vec3</span>(<span class="number">1.1f</span>, <span class="number">1.1f</span>, <span class="number">1.1f</span>));</span><br><span class="line"></span><br><span class="line">        _shader_color.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(VAO_cube);</span><br><span class="line">        <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    _shader_color.<span class="built_in">end</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glStencilFunc</span>(GL_ALWAYS, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">    <span class="comment">//////绘制太阳</span></span><br><span class="line">    _shader_sun.<span class="built_in">start</span>();</span><br><span class="line">    _shader_sun.<span class="built_in">setMatrix</span>(<span class="string">&quot;_viewMatrix&quot;</span>, _camera.<span class="built_in">getMatrix</span>());</span><br><span class="line">    _shader_sun.<span class="built_in">setMatrix</span>(<span class="string">&quot;_projMatrix&quot;</span>, _projMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, pointLightPositions[i]);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">scale</span>(_modelMatrix, glm::<span class="built_in">vec3</span>(<span class="number">0.2f</span>, <span class="number">0.2f</span>, <span class="number">0.2f</span>));</span><br><span class="line">        _shader_sun.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(VAO_sun);</span><br><span class="line">        <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _shader_sun.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Blending-效果"><a href="#Blending-效果" class="headerlink" title="Blending 效果"></a>Blending 效果</h2><h3 id="透明的原理"><a href="#透明的原理" class="headerlink" title="透明的原理"></a>透明的原理</h3><p>RGBA格式A这个值,即ALPHA</p>
<p>Alpha定义:本色块,在与ColorBuffer当中的颜色产生混合的时候,所占有的比例</p>
<p>颜色混合公式:</p>
<p>Color &#x3D; source* alpha + destination * (1-alpha)</p>
<p>source:要绘制的物体本Fragment的像素颜色值<br>alpha:要绘制的物体本Fragment的Alpha值<br>destination:ColorBuffer里面目标点的颜色值</p>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p><strong>glEnable(GL_BLEND);</strong></p>
<h4 id="第一步-计算出源颜色与目标颜色"><a href="#第一步-计算出源颜色与目标颜色" class="headerlink" title="第一步,计算出源颜色与目标颜色"></a>第一步,计算出源颜色与目标颜色</h4><p><strong>glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</strong><br><strong>glBlendFuncSeparate(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA, GL_ONE, GL_ZERO);</strong></p>
<h4 id="第二步-设置计算后的SRC颜色与DST颜色之间的计算方式"><a href="#第二步-设置计算后的SRC颜色与DST颜色之间的计算方式" class="headerlink" title="第二步,设置计算后的SRC颜色与DST颜色之间的计算方式"></a>第二步,设置计算后的SRC颜色与DST颜色之间的计算方式</h4><p><strong>glBlendEquation(GLenum mode)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GL_FUNC_ADD: the default, adds both colors to each other: Cresult = Src + Dst.</span><br><span class="line">GL_FUNC_SUBTRACT: subtracts both colors from each other: Cresult = Src - Dst.</span><br><span class="line">GL_FUNC_REVERSE_SUBTRACT: subtracts both colors, but reverses order: Cresult = Dst - Src.</span><br><span class="line">GL_MIN: takes the component-wise minimum of both colors: Cresult = min(Dst, Src).</span><br><span class="line">GL_MAX: takes the component-wise maximum of both colors: Cresult = max(Dst, Src).</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//数据</span></span><br><span class="line">    std::vector&lt;glm::vec3&gt; _window_pos</span><br><span class="line">    &#123;</span><br><span class="line">        glm::<span class="built_in">vec3</span>(<span class="number">-1.5f</span>, <span class="number">0.0f</span>, <span class="number">-0.48f</span>),</span><br><span class="line">        glm::<span class="built_in">vec3</span>(<span class="number">1.5f</span>, <span class="number">0.0f</span>, <span class="number">0.51f</span>),</span><br><span class="line">        glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.7f</span>),</span><br><span class="line">        glm::<span class="built_in">vec3</span>(<span class="number">-0.3f</span>, <span class="number">0.0f</span>, <span class="number">-2.3f</span>),</span><br><span class="line">        glm::<span class="built_in">vec3</span>(<span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">-0.6f</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    std::map&lt;<span class="type">float</span>, glm::vec3&gt; _window_sort;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; _window_pos.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">float</span> _dist = glm::<span class="built_in">length</span>(_camera.<span class="built_in">getPosition</span>() - _window_pos[i]);</span><br><span class="line">        _window_sort[_dist] = _window_pos[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glClearColor</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">    <span class="built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _camera.<span class="built_in">update</span>();</span><br><span class="line">    _projMatrix = glm::<span class="built_in">perspective</span>(glm::<span class="built_in">radians</span>(<span class="number">45.0f</span>), (<span class="type">float</span>)_width / (<span class="type">float</span>)_height, <span class="number">0.1f</span>, <span class="number">100.0f</span>);</span><br><span class="line">    glm::mat4 _modelMatrix(<span class="number">1.0f</span>);</span><br><span class="line">    _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-3.0f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glActiveTexture</span>(GL_TEXTURE0);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _textureBox);</span><br><span class="line"></span><br><span class="line">    _shader.<span class="built_in">start</span>();</span><br><span class="line">    _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line">    _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_viewMatrix&quot;</span>, _camera.<span class="built_in">getMatrix</span>());</span><br><span class="line">    _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_projMatrix&quot;</span>, _projMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制地面</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(VAO_plane);</span><br><span class="line">    <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制方盒</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(VAO_cube);</span><br><span class="line">    <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制窗体</span></span><br><span class="line">    <span class="keyword">for</span> (std::map&lt;<span class="type">float</span>, glm::vec3&gt;::reverse_iterator _it = _window_sort.<span class="built_in">rbegin</span>(); _it != _window_sort.<span class="built_in">rend</span>(); _it++)</span><br><span class="line">    &#123;</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">        _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, _it-&gt;second);</span><br><span class="line">        _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line">        <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _textureWindow);</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(VAO_window);</span><br><span class="line">        <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _shader.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint <span class="title">createPlane</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    uint _VAO = <span class="number">0</span>;</span><br><span class="line">    uint _VBO = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">glGenVertexArrays</span>(<span class="number">1</span>, &amp;_VAO);</span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(_VAO);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;_VBO);</span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, _VBO);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> planeVertices[] = &#123;</span><br><span class="line">         <span class="number">5.0f</span>, <span class="number">-0.5f</span>,  <span class="number">5.0f</span>,  <span class="number">2.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">        <span class="number">-5.0f</span>, <span class="number">-0.5f</span>,  <span class="number">5.0f</span>,  <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">        <span class="number">-5.0f</span>, <span class="number">-0.5f</span>, <span class="number">-5.0f</span>,  <span class="number">0.0f</span>, <span class="number">2.0f</span>,</span><br><span class="line"></span><br><span class="line">         <span class="number">5.0f</span>, <span class="number">-0.5f</span>,  <span class="number">5.0f</span>,  <span class="number">2.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">        <span class="number">-5.0f</span>, <span class="number">-0.5f</span>, <span class="number">-5.0f</span>,  <span class="number">0.0f</span>, <span class="number">2.0f</span>,</span><br><span class="line">         <span class="number">5.0f</span>, <span class="number">-0.5f</span>, <span class="number">-5.0f</span>,  <span class="number">2.0f</span>, <span class="number">2.0f</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(planeVertices), planeVertices, GL_STATIC_DRAW);</span><br><span class="line">    <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">5</span> * <span class="built_in">sizeof</span>(<span class="type">float</span>), (<span class="type">void</span>*)<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, GL_FLOAT, GL_FALSE, <span class="number">5</span> * <span class="built_in">sizeof</span>(<span class="type">float</span>), (<span class="type">void</span>*)(<span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _VAO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>为了避免深度缓存的问题 我们根据相机的距离先绘制最远的窗体</strong></p>
<h2 id="cullFace表面剔除"><a href="#cullFace表面剔除" class="headerlink" title="cullFace表面剔除"></a>cullFace表面剔除</h2><p><strong>解决多余的绘制</strong></p>
<h3 id="定义面的顶点绘制顺序"><a href="#定义面的顶点绘制顺序" class="headerlink" title="定义面的顶点绘制顺序"></a>定义面的顶点绘制顺序</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805165408784.png" alt="image-20240805165408784" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805165557730.png" alt="image-20240805165557730" style="zoom: 67%;" />

<h3 id="接口-1"><a href="#接口-1" class="headerlink" title="接口"></a>接口</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glEnable</span>(GL_CULL_FACE);</span><br><span class="line"><span class="built_in">glCullFace</span>(GL_FRONT);</span><br><span class="line">GL_BACK: Culls only the back fases.</span><br><span class="line">GL_FRONT: Culls only the front faces.</span><br><span class="line">GL_FRONT_AND_BACK: Culls both the front <span class="keyword">and</span> back</span><br><span class="line">faces.</span><br><span class="line"></span><br><span class="line"><span class="built_in">glFrontFace</span>(GL_CCW); 也可以是GL_CW</span><br></pre></td></tr></table></figure>

<p>glFrontFace 定义正面是顺时针还是逆时针</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glClearColor</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"><span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glEnable</span>(GL_CULL_FACE);</span><br><span class="line"><span class="built_in">glFrontFace</span>(GL_CCW); <span class="comment">// GL_CCW 逆时针方向为正面方向 GL_CW 顺时针为正</span></span><br></pre></td></tr></table></figure>

<h2 id="FramBuffer-帧缓存"><a href="#FramBuffer-帧缓存" class="headerlink" title="FramBuffer 帧缓存"></a>FramBuffer 帧缓存</h2><p>帧缓存不是指一块显存,而是类似于VAO的一个组织结构,他里面包含了很多附件<br>(ColorBuffer,DepthBuffer,StencilBuffer),附件里面会根据不同需求开辟不同的<br>显存空间</p>
<p>长期以来,我们都是用默认的帧缓存来做渲染,默认的是0号帧缓存</p>
<p>创建一个属于我们自己的额外的帧缓存,并且利用它来做后处<br>理(Post-Process),这种渲染方式为离屏渲染(off-screen rending)</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240805173315575.png" alt="image-20240805173315575" style="zoom:67%;" />

<h3 id="创建帧缓存"><a href="#创建帧缓存" class="headerlink" title="创建帧缓存"></a>创建帧缓存</h3><p>创建帧缓存ID的方式跟vao vbo texture等一样</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> fbo;</span><br><span class="line"><span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;fbo);</span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, fbo);</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">glCheckFramebufferStatus</span>(GL_FRAMEBUFFER) == GL_FRAMEBUFFER_COMPLETE)</span><br><span class="line"></span><br><span class="line"><span class="comment">//接下来进行附件的创建与绑定操作</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER,<span class="number">0</span>);<span class="comment">//恢复原始的默认FrameBuffer</span></span><br><span class="line"><span class="built_in">glDeleteFramebuffers</span>(<span class="number">1</span>,&amp;fbo);<span class="comment">//没用了可以删除FrameBuffer</span></span><br></pre></td></tr></table></figure>

<h4 id="原则"><a href="#原则" class="headerlink" title="原则:"></a>原则:</h4><ol>
<li>帧缓存需要至少绑定一个附件(color depth stencil)</li>
<li>至少有一个ColorBuffer绑定</li>
<li>每个绑定的附件必须都开辟内存完毕</li>
<li>每个绑定的附件必须都有相同的采样标准(N*M个像素数据信息)</li>
</ol>
<h3 id="Texture-作为Buffer附件ColorBuffer"><a href="#Texture-作为Buffer附件ColorBuffer" class="headerlink" title="Texture 作为Buffer附件ColorBuffer"></a>Texture 作为Buffer附件ColorBuffer</h3><p>创建Texture:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> texture;</span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;texture);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, texture);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glTexlmage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGB, <span class="number">800</span>, <span class="number">600</span>, <span class="number">0</span>, GL_RGB, GL_UNSIGNED_BYTE, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENTO, GL_TEXTURE_2D, texture, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">创建Texture:</span><br><span class="line"></span><br><span class="line"><span class="built_in">glTexlmage2D</span>(</span><br><span class="line">GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH24_STENCIL8, <span class="number">800</span>, <span class="number">600</span>, <span class="number">0</span>,</span><br><span class="line">GL_DEPTH_STENCIL, GL_UNSIGNED_INT_24_8, <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, texture, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="RenderBuffer作为Buffer附件ColorBuffer"><a href="#RenderBuffer作为Buffer附件ColorBuffer" class="headerlink" title="RenderBuffer作为Buffer附件ColorBuffer"></a>RenderBuffer作为Buffer附件ColorBuffer</h3><h4 id="创建RenderBuffer"><a href="#创建RenderBuffer" class="headerlink" title="创建RenderBuffer"></a>创建RenderBuffer</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uint colorBuffer;</span><br><span class="line"><span class="built_in">glGenRenderbuffers</span>(<span class="number">1</span>, &amp;colorBuffer);</span><br><span class="line"><span class="built_in">glBindRenderbuffer</span>(GL_RENDERBUFFER, colorBuffer);</span><br><span class="line"><span class="built_in">glRenderbufferStorage</span>(GL_RENDERBUFFER, GL_RGBA, <span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glFramebufferRenderbuffer</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENTO, GL_RENDERBUFFER, colorBuffer);</span><br></pre></td></tr></table></figure>

<p><strong>Texture作为ColorBuffer，RenderBuffer作为D&#x2F;S Buffer</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806120326003.png" alt="image-20240806120326003"></p>
<h3 id="FrameBuffer-渲染流程"><a href="#FrameBuffer-渲染流程" class="headerlink" title="FrameBuffer 渲染流程"></a>FrameBuffer 渲染流程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806120721581.png" alt="image-20240806120721581"></p>
<h2 id="CubeMap"><a href="#CubeMap" class="headerlink" title="CubeMap"></a>CubeMap</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806150510384.png" alt="image-20240806150510384" style="zoom:67%;" />

<p><strong>s 坐标</strong>: 表示纹理坐标系中沿水平轴（X 轴）的坐标。</p>
<p><strong>t 坐标</strong>: 表示纹理坐标系中沿垂直轴（Y 轴）的坐标。</p>
<p><strong>r 坐标</strong>: 表示与立方体面法线方向相关的深度坐标（Z 轴）。</p>
<h3 id="CubeMap接口"><a href="#CubeMap接口" class="headerlink" title="CubeMap接口"></a>CubeMap接口</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240816183316248.png" alt="image-20240816183316248" style="zoom:67%;" />

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> texturelD;</span><br><span class="line">    <span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;textureID);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_CUBE_MAP, textureID);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> width, height, nrChannels;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *data;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; textures_faces.<span class="built_in">size</span>(); i++)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        data = <span class="built_in">stbi_load</span>(textures_faces[i].<span class="built_in">c_str</span>(), &amp;width, &amp;height, &amp;nrChannels, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">glTexlmage2D</span>(</span><br><span class="line">        GL_TEXTURE_CUBE_MAP_POSITIVE_X +i, <span class="number">0</span>, GL_RGB, width, height, <span class="number">0</span>, GL_RGB, GL_UNSIGNED_BYTE, data);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glTexParameteri</span>(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line">    <span class="built_in">glTexParameteri</span>(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line">    <span class="built_in">glTexParameteri</span>(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</span><br><span class="line">    <span class="built_in">glTexParameteri</span>(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</span><br><span class="line">    <span class="built_in">glTexParameteri</span>(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="天空盒理论"><a href="#天空盒理论" class="headerlink" title="天空盒理论"></a>天空盒理论</h3><ol>
<li><p>设置一个正方体VAO,每个方向的取值范围是-1到1,并且质心位于坐标原点</p>
</li>
<li><p>做一个CubeMap的Texture并且为六个面都设置目标贴图</p>
</li>
<li><p>在正方体VertexShader当中,把坐标直接传给FragmentShader(插值后的结果),并且去掉摄像机矩阵对于平移的影响</p>
</li>
<li><p>在FragmentShader当中利用坐标来做STR坐标,采样CubeMap给到outFrag</p>
</li>
<li><p>但是每次都必须先绘制天空盒</p>
</li>
</ol>
<h3 id="天空盒Shader解析"><a href="#天空盒Shader解析" class="headerlink" title="天空盒Shader解析"></a>天空盒Shader解析</h3><h4 id="VertexShader"><a href="#VertexShader" class="headerlink" title="VertexShader"></a>VertexShader</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> aPos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> TexCoords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> projection;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> view;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    TexCoords = aPos;</span><br><span class="line">    <span class="built_in">gl_Position</span> = projection * view * <span class="type">vec4</span>(aPos, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FragmentShader"><a href="#FragmentShader" class="headerlink" title="FragmentShader"></a>FragmentShader</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FragmentShader:</span><br><span class="line">in vec3 TexCoords;</span><br><span class="line">uniform samplerCube cubemap;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FragColor = <span class="built_in">texture</span>(cubemap, TexCoords);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接用物理坐标给纹理坐标赋值</strong></p>
<h3 id="天空盒优化"><a href="#天空盒优化" class="headerlink" title="天空盒优化"></a>天空盒优化</h3><h4 id="问题"><a href="#问题" class="headerlink" title="问题:"></a>问题:</h4><p><strong>每次都需要优先绘制天空盒,天空盒铺满整个屏幕,所以对于性能还是有一定的损耗,如何能够将天空盒的深度都做到最深呢?</strong></p>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化:"></a>优化:</h4><p>gl_Position变量在每次设置的时候,都是非NDC坐标,他跟NDC之间唯一的差距在于还没<br>有对xyz除以w值,在绘制天空盒的时候,将gl_Position变量设置为pos.xyww,gl_Position就会在<br>下一阶段计算深度值z得时候,用当前的Z除以w,即w&#x2F;W,直接得到Z&#x3D;1,即最大深度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void main()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    TexCoords = aPos;</span><br><span class="line">    vec4 pos = projection * view * vec4(aPos, 1.0);</span><br><span class="line">    gl_Position = pos.xyww;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gl_Position-gl_FragCoord,</span><br></pre></td></tr></table></figure>

<h2 id="环境贴图"><a href="#环境贴图" class="headerlink" title="环境贴图"></a>环境贴图</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806165529599.png" alt="image-20240806165529599"></p>
<h3 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806165716795.png" alt="image-20240806165716795"></p>
<p><em><em>Normal &#x3D; mat3（transpose（inverse（model）））</em> aNormal</em>*</p>
<h3 id="折射"><a href="#折射" class="headerlink" title="折射"></a>折射</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240806174008672.png" alt="image-20240806174008672" style="zoom: 50%;" />

<h2 id="数据接口"><a href="#数据接口" class="headerlink" title="数据接口"></a>数据接口</h2><h3 id="定点数据拷贝"><a href="#定点数据拷贝" class="headerlink" title="定点数据拷贝"></a>定点数据拷贝</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glBufferSubData</span>(GL_ARRAY_BUFFER, <span class="number">24</span> <span class="built_in">sizeof</span>(data), &amp;data);</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>向Buffer中进行定点数据拷贝</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240809172329603.png"></p>
</li>
<li><p><strong>进行不同的数据打包方式</strong></p>
</li>
<li><p><strong>在不同的buffer之间拷贝数据</strong></p>
</li>
<li><p><strong>拷贝的数据指针</strong></p>
</li>
</ol>
<p><strong>多次修改数据，会造成性能上的浪费， 每次从内存将数据拷贝到显存</strong></p>
<h3 id="glMapBuffer-虚拟指针"><a href="#glMapBuffer-虚拟指针" class="headerlink" title="glMapBuffer 虚拟指针"></a>glMapBuffer 虚拟指针</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812102644240.png" alt="image-20240812102644240" style="zoom:67%;" />

<h3 id="顶点数据打包方式"><a href="#顶点数据打包方式" class="headerlink" title="顶点数据打包方式"></a>顶点数据打包方式</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812103621644.png" alt="image-20240812103621644" style="zoom:67%;" />

<h3 id="buffer之间的数据拷贝"><a href="#buffer之间的数据拷贝" class="headerlink" title="buffer之间的数据拷贝"></a>buffer之间的数据拷贝</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glBindBuffer</span>(GL_COPY_READ_BUFFER, vbo1)</span><br><span class="line"><span class="built_in">glBindBuffer</span>(GL_COPy_WRITE_BUFFER, vbo2)</span><br><span class="line"><span class="built_in">glCopyBufferSubData</span>(GL_COPY_READ_BUFFER, GL_COPY_WIRTE_BBUFFER, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>*<span class="built_in">sizeof</span>(<span class="type">float</span>)) <span class="comment">// 从read 0 开始读，从write 0 开始写， 数据大小</span></span><br></pre></td></tr></table></figure>

<h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812104147630.png" alt="image-20240812104147630" style="zoom: 67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812104844360.png" alt="image-20240812104844360" style="zoom: 67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812105017535.png" alt="image-20240812105017535" style="zoom: 67%;" />

<ul>
<li><strong>return；继续渲染</strong></li>
<li><strong>discard；丢弃</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812111355755.png" alt="image-20240812111355755"></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812113518916.png" alt="image-20240812113518916" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812113801772.png" alt="image-20240812113801772" style="zoom:67%;" />

<h3 id="接口数据块-Blocks"><a href="#接口数据块-Blocks" class="headerlink" title="接口数据块 Blocks"></a>接口数据块 Blocks</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812113941818.png" alt="image-20240812113941818" style="zoom:67%;" />

<h2 id="UniformBlock-显存分配"><a href="#UniformBlock-显存分配" class="headerlink" title="UniformBlock 显存分配"></a>UniformBlock 显存分配</h2><h3 id="全局数据块-Uniform-Buffer-Object"><a href="#全局数据块-Uniform-Buffer-Object" class="headerlink" title="全局数据块 Uniform Buffer Object"></a>全局数据块 Uniform Buffer Object</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812114647190.png" alt="image-20240812114647190" style="zoom:67%;" />

<p>Uniform变量在UBO显存重点存储方式：Shared，std140，packed，std430</p>
<h3 id="shared-默认方式"><a href="#shared-默认方式" class="headerlink" title="**shared 默认方式 **"></a>**shared 默认方式 **</h3><h3 id="std140"><a href="#std140" class="headerlink" title="std140"></a><strong>std140</strong></h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812122919238.png" alt="image-20240812122919238" style="zoom:67%;" />

<h3 id="UBO-生成过程"><a href="#UBO-生成过程" class="headerlink" title="UBO 生成过程"></a>UBO 生成过程</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240812153754072.png" alt="image-20240812153754072" style="zoom:67%;" />

<p>先绑定UBO 然后根据UBO绑定Shader</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UBO两种绑定方式</span></span><br><span class="line"><span class="built_in">glBindBufferBase</span>(GL_UNIFORM_BUFFER, <span class="number">2</span>, uboExampleBlock);			<span class="comment">// 直接绑定</span></span><br><span class="line"><span class="built_in">glBindBufferRange</span>(GL_UNIFORM_BUFFER, <span class="number">2</span>, uboExampleBlock, <span class="number">0</span>, <span class="number">152</span>);	<span class="comment">// 绑定范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Shader里有Light的uniform block的生命， 可以进行绑定</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> lights_index = <span class="built_in">glGetUniformBlockIndex</span>(shaderA.ID, <span class="string">&quot;Lights&quot;</span>);</span><br><span class="line"><span class="built_in">glUniformBlockBinding</span>(shaderA.ID, lights_index, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<h3 id="core-code-省略后"><a href="#core-code-省略后" class="headerlink" title="core code 省略后"></a>core code 省略后</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init shader</span></span><br><span class="line">Shader          _shader;</span><br><span class="line">Shader          _shader_red;</span><br><span class="line">Shader          _shader_green;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initShader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _shader.<span class="built_in">initShader</span>(<span class="string">&quot;shader/vertexShader.glsl&quot;</span>, <span class="string">&quot;shader/fragmentShader.glsl&quot;</span>);</span><br><span class="line">    _shader_red.<span class="built_in">initShader</span>(<span class="string">&quot;shader/redShaderv.glsl&quot;</span>, <span class="string">&quot;shader/redShaderf.glsl&quot;</span>);</span><br><span class="line">    _shader_green.<span class="built_in">initShader</span>(<span class="string">&quot;shader/greenShaderv.glsl&quot;</span>, <span class="string">&quot;shader/greenShaderf.glsl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint <span class="title">createUBO</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    uint _ubo = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;_ubo);</span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_UNIFORM_BUFFER, _ubo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_UNIFORM_BUFFER, <span class="number">2</span> * <span class="built_in">sizeof</span>(glm::mat4), <span class="literal">NULL</span>, GL_DYNAMIC_DRAW);</span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_UNIFORM_BUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _ubo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bindShaderData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glBindBufferBase</span>(GL_UNIFORM_BUFFER, <span class="number">0</span>, UBO);</span><br><span class="line"></span><br><span class="line">    uint redIndex = <span class="built_in">glGetUniformBlockIndex</span>(_shader_red.<span class="built_in">getProgram</span>(), <span class="string">&quot;MAT&quot;</span>);</span><br><span class="line">    <span class="built_in">glUniformBlockBinding</span>(_shader_red.<span class="built_in">getProgram</span>(), redIndex, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uint greenIndex = <span class="built_in">glGetUniformBlockIndex</span>(_shader_green.<span class="built_in">getProgram</span>(), <span class="string">&quot;MAT&quot;</span>);</span><br><span class="line">    <span class="built_in">glUniformBlockBinding</span>(_shader_green.<span class="built_in">getProgram</span>(), greenIndex, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//uniform 数据填充</span></span><br><span class="line">    <span class="built_in">glBufferSubData</span>(GL_UNIFORM_BUFFER, <span class="number">0</span>, <span class="built_in">sizeof</span>(glm::mat4), glm::<span class="built_in">value_ptr</span>(_projMatrix));</span><br><span class="line">    <span class="built_in">glBufferSubData</span>(GL_UNIFORM_BUFFER, <span class="built_in">sizeof</span>(glm::mat4), <span class="built_in">sizeof</span>(glm::mat4), glm::<span class="built_in">value_ptr</span>(_camera.<span class="built_in">getMatrix</span>()));</span><br><span class="line"></span><br><span class="line">    _shader_red.<span class="built_in">start</span>();</span><br><span class="line">    _shader_red.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制方盒</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(VAO_cube);</span><br><span class="line">    <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">    _shader_red.<span class="built_in">end</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _shader_green.<span class="built_in">start</span>();</span><br><span class="line">    _modelMatrix = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">    _modelMatrix = glm::<span class="built_in">translate</span>(_modelMatrix, glm::<span class="built_in">vec3</span>(<span class="number">2.0f</span>, <span class="number">0</span>, <span class="number">-3.0f</span>));</span><br><span class="line">    _shader_green.<span class="built_in">setMatrix</span>(<span class="string">&quot;_modelMatrix&quot;</span>, _modelMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制方盒</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(VAO_cube);</span><br><span class="line">    <span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">    _shader_green.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GeometryShader-几何着色器"><a href="#GeometryShader-几何着色器" class="headerlink" title="GeometryShader 几何着色器"></a>GeometryShader 几何着色器</h2><h3 id="几何着色器原理"><a href="#几何着色器原理" class="headerlink" title="几何着色器原理"></a>几何着色器原理</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813112627591.png" alt="image-20240813112627591" style="zoom: 67%;" />

<p>几何着色器对装配的顶点进行生成或减除操作 重新定义图元的类型</p>
<h4 id="点输入"><a href="#点输入" class="headerlink" title="点输入"></a>点输入</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813113119032.png" alt="image-20240813113119032" style="zoom:67%;" />

<h4 id="三角形输入"><a href="#三角形输入" class="headerlink" title="三角形输入"></a>三角形输入</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813113216231.png" alt="image-20240813113216231" style="zoom:67%;" />

<p>每三个一组创建一个gl_in将变量放到gl_in中，输送给Geometry Shading</p>
<h4 id="Geometry-输出-重新定义了图元装配的类型"><a href="#Geometry-输出-重新定义了图元装配的类型" class="headerlink" title="Geometry 输出 重新定义了图元装配的类型"></a>Geometry 输出 重新定义了图元装配的类型</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813114156720.png" alt="image-20240813114156720" style="zoom:67%;" />

<h4 id="GeometryShader"><a href="#GeometryShader" class="headerlink" title="GeometryShader"></a>GeometryShader</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># version 330 core</span></span><br><span class="line"><span class="keyword">layout</span> (point)<span class="keyword">in</span>;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">line_strip</span>, <span class="keyword">max_vertices</span>=<span class="number">2</span>) <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()&#123;</span><br><span class="line">	<span class="built_in">gl_Position</span> ==  <span class="built_in">gl_in</span>[<span class="number">0</span>].<span class="built_in">gl_Position</span> + <span class="type">vec4</span>(<span class="number">-0.1</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">	<span class="built_in">EmitVertex</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">gl_Position</span> = <span class="built_in">gl_in</span>[<span class="number">0</span>].<span class="built_in">gl_Position</span> + <span class="type">vec4</span>(<span class="number">0.1</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">	Emitvertex();</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">EndPrimitive</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813115017884.png" alt="image-20240813115017884" style="zoom:67%;" />

<h4 id="gl-in"><a href="#gl-in" class="headerlink" title="gl_in"></a>gl_in</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">in gl_Vertex</span><br><span class="line">&#123;</span><br><span class="line">	vec4 gl_Position;</span><br><span class="line">	<span class="type">float</span> gl_PointSize;</span><br><span class="line">	<span class="type">float</span> gl_ClipDistance[];	<span class="comment">// 剪裁距离</span></span><br><span class="line">&#125;gl_in[];</span><br></pre></td></tr></table></figure>

<h3 id="法向量可视化"><a href="#法向量可视化" class="headerlink" title="法向量可视化"></a>法向量可视化</h3><ul>
<li>STEP1	正常渲染模型</li>
<li>STEP2	使用geometryShader方式渲染模型，得到法向量</li>
</ul>
<h4 id="VertexShader-1"><a href="#VertexShader-1" class="headerlink" title="VertexShader"></a>VertexShader</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> aPos;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec3</span> aNormal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> normal;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> view;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> model;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">	gl_position = view * model * <span class="type">vec4</span>(aPos, <span class="number">1.0</span>);</span><br><span class="line">	<span class="type">mat3</span> normalMatrix = <span class="type">mat3</span>(<span class="built_in">transpose</span>(<span class="built_in">inverse</span>(view * model)))；</span><br><span class="line">	normal = normailize(<span class="type">vec3</span>(normalMatrix * aNormal, <span class="number">0.0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GeometryShader-1"><a href="#GeometryShader-1" class="headerlink" title="GeometryShader"></a>GeometryShader</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">triangles</span>) <span class="keyword">in</span>;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">line_strip</span>, <span class="keyword">max_vertices</span> = <span class="number">6</span>) <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec3</span> normal;</span><br><span class="line"><span class="keyword">const</span> <span class="type">float</span> MAGNITUDE = <span class="number">0.4</span>l</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> projection;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> GenerateLine(<span class="type">int</span> <span class="keyword">index</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">gl_Position</span> = projection * <span class="built_in">gl_in</span>[<span class="keyword">index</span>].gl_position;</span><br><span class="line">	<span class="built_in">EmitVertex</span>();</span><br><span class="line">	<span class="built_in">gl_Position</span> = projection * (<span class="built_in">gl_in</span>[<span class="keyword">index</span>].gl_position + <span class="type">vec4</span>(normal, <span class="number">0.0</span>) * MAGNITUDE);</span><br><span class="line">    <span class="built_in">EmitVertex</span>();</span><br><span class="line">    <span class="built_in">EndPrimitive</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模型读取"><a href="#模型读取" class="headerlink" title="模型读取"></a>模型读取</h2><h3 id="模型材质"><a href="#模型材质" class="headerlink" title="模型材质"></a>模型材质</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813151740855.png" alt="image-20240813151740855" style="zoom:67%;" />

<h3 id="Assimp库（读取）"><a href="#Assimp库（读取）" class="headerlink" title="Assimp库（读取）"></a>Assimp库（读取）</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240813151822375.png" alt="image-20240813151822375" style="zoom:67%;" />

<h4 id="Scene"><a href="#Scene" class="headerlink" title="Scene"></a>Scene</h4><ul>
<li>mRootNode    场景根节点</li>
<li>mMeshs[]	模型顶点信息综合</li>
<li>mMaterials[]   模型贴图信息</li>
</ul>
<h4 id="Child-node"><a href="#Child-node" class="headerlink" title="Child node"></a>Child node</h4><p>部分模型信息</p>
<h3 id="Mesh"><a href="#Mesh" class="headerlink" title="Mesh"></a>Mesh</h3><ul>
<li>模型块，包含构建模型块的所有顶点信息（坐标，法线，UV，索引，纹理等）</li>
<li>模型块数据结构 Vertex Texture Index</li>
<li>函数：构造函数，VBO&#x2F;VAO 设置函数， 绘制函数</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FF</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	ffBone::<span class="built_in">ffBone</span>(<span class="type">int</span> _id, std::string _name, aiMatrix4x4 _aiMatrix)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//m_mesh = _pMesh;</span></span><br><span class="line">		m_id = _id;</span><br><span class="line">		m_name = _name;</span><br><span class="line">		m_offsetMat = <span class="built_in">AiToGLMMat4</span>(_aiMatrix);</span><br><span class="line"></span><br><span class="line">		m_parent = <span class="literal">NULL</span>;</span><br><span class="line">		m_parentSkeleton = <span class="literal">NULL</span>;</span><br><span class="line">		m_aiAnim = <span class="literal">NULL</span>;</span><br><span class="line">		m_aiNode = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ffBone::<span class="built_in">ffBone</span>(<span class="type">int</span> _id, std::string _name, glm::mat4 _matrix)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//m_mesh = _pMesh;</span></span><br><span class="line">		m_id = _id;</span><br><span class="line">		m_name = _name;</span><br><span class="line">		m_offsetMat = _matrix;</span><br><span class="line"></span><br><span class="line">		m_parent = <span class="literal">NULL</span>;</span><br><span class="line">		m_aiAnim = <span class="literal">NULL</span>;</span><br><span class="line">		m_aiNode = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">glm::mat4 <span class="title">ffBone::getParentsTransform</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		ffBone* _pBone = m_parent;</span><br><span class="line">		std::vector&lt;glm::mat4&gt; _matrixArr;</span><br><span class="line"></span><br><span class="line">		glm::mat4 _tmpMat = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">		<span class="keyword">while</span> (_pBone)</span><br><span class="line">		&#123;</span><br><span class="line">			_tmpMat = <span class="built_in">AiToGLMMat4</span>(_pBone-&gt;m_aiNode-&gt;mTransformation);</span><br><span class="line">			_matrixArr.<span class="built_in">push_back</span>(_tmpMat);</span><br><span class="line">			_pBone = _pBone-&gt;m_parent;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		glm::mat4 _concatenatedTransform = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">		<span class="keyword">for</span> (uint i = _matrixArr.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt; <span class="number">-1</span>; --i)</span><br><span class="line">		&#123;</span><br><span class="line">			_concatenatedTransform *= _matrixArr[i];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> _concatenatedTransform;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffSkeleton::init</span><span class="params">(std::vector&lt;ffBone&gt; _boneArr, glm::mat4 _globalInverseTransform)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		m_globalInverseTransform = _globalInverseTransform;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _boneArr.<span class="built_in">size</span>(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			m_boneMap[_boneArr[i].m_id] = _boneArr[i];</span><br><span class="line">			_boneArr[i].m_parentSkeleton = <span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*ffBone* ffSkeleton::findBoneByName(std::string _name)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		for (uint i = 0; i &lt; m_boneArr.size(); i++)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			if (m_boneArr[i].m_name == _name)</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">				return &amp;m_boneArr[i];</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		return NULL;</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffSkeleton::updateBoneMats</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffSkeleton::update</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	ffMesh::<span class="built_in">ffMesh</span>(std::vector&lt;ffVertex&gt; _vertexVec, std::vector&lt;uint&gt; _indexVec, std::vector&lt;ffTexture&gt; _texVec)</span><br><span class="line">	&#123;</span><br><span class="line">		m_vertexVec = _vertexVec;</span><br><span class="line">		m_indexVec = _indexVec;</span><br><span class="line">		m_texVec = _texVec;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">setupMesh</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffMesh::draw</span><span class="params">(Shader&amp; _shader)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		uint _diffuseN = <span class="number">1</span>;</span><br><span class="line">		uint _specularN = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; m_texVec.<span class="built_in">size</span>(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">glActiveTexture</span>(GL_TEXTURE0 + i);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//拼装shader传参字符串</span></span><br><span class="line">			std::string _typeName = m_texVec[i].m_type;</span><br><span class="line">			std::string _numStr;</span><br><span class="line">			<span class="keyword">if</span> (_typeName == TEXTURE_DIFFUSE_STR)</span><br><span class="line">			&#123;</span><br><span class="line">				_numStr = std::<span class="built_in">to_string</span>(_diffuseN++);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (_typeName == TEXTURE_SPECULAR_STR)</span><br><span class="line">			&#123;</span><br><span class="line">				_numStr = std::<span class="built_in">to_string</span>(_specularN++);</span><br><span class="line">			&#125;</span><br><span class="line">			_shader.<span class="built_in">setFloat</span>(<span class="string">&quot;myMaterial.&quot;</span> + _typeName + _numStr, i);</span><br><span class="line">			<span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_texVec[i].m_id);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glActiveTexture</span>(GL_TEXTURE0);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBindVertexArray</span>(m_VAO);</span><br><span class="line">		<span class="built_in">glDrawElements</span>(GL_TRIANGLES, m_indexVec.<span class="built_in">size</span>(), GL_UNSIGNED_INT, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffMesh::setupMesh</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		uint _VBO = <span class="number">0</span>;</span><br><span class="line">		uint _EBO = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glGenVertexArrays</span>(<span class="number">1</span>, &amp;m_VAO);</span><br><span class="line">		<span class="built_in">glBindVertexArray</span>(m_VAO);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;_VBO);</span><br><span class="line">		<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, _VBO);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(ffVertex) * m_vertexVec.<span class="built_in">size</span>(), &amp;m_vertexVec[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;_EBO);</span><br><span class="line">		<span class="built_in">glBindBuffer</span>(GL_ELEMENT_ARRAY_BUFFER, _EBO);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBufferData</span>(GL_ELEMENT_ARRAY_BUFFER, <span class="built_in">sizeof</span>(uint) * m_indexVec.<span class="built_in">size</span>(), &amp;m_indexVec[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glEnableVertexAttribArray</span>(SHADER_POSITION_ANCHOR);</span><br><span class="line">		<span class="built_in">glVertexAttribPointer</span>(SHADER_POSITION_ANCHOR, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(ffVertex), (<span class="type">void</span>*)<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glEnableVertexAttribArray</span>(SHADER_NORMAL_ANCHOR);</span><br><span class="line">		<span class="built_in">glVertexAttribPointer</span>(SHADER_NORMAL_ANCHOR, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(ffVertex), (<span class="type">void</span>*)<span class="built_in">offsetof</span>(ffVertex, m_normal));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glEnableVertexAttribArray</span>(SHADER_TEXCOORD_ANCHOR);</span><br><span class="line">		<span class="built_in">glVertexAttribPointer</span>(SHADER_TEXCOORD_ANCHOR, <span class="number">2</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(ffVertex), (<span class="type">void</span>*)<span class="built_in">offsetof</span>(ffVertex, m_texCoord));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glEnableVertexAttribArray</span>(SHADER_BONE_WEIGHT_ANCHOR);</span><br><span class="line">		<span class="built_in">glVertexAttribPointer</span>(SHADER_BONE_WEIGHT_ANCHOR, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(ffVertex), (<span class="type">void</span>*)<span class="built_in">offsetof</span>(ffVertex, m_weightArr));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glEnableVertexAttribArray</span>(SHADER_BONE_ID_ANCHOR);</span><br><span class="line">		<span class="built_in">glVertexAttribIPointer</span>(SHADER_BONE_ID_ANCHOR, <span class="number">4</span>, GL_INT, <span class="built_in">sizeof</span>(ffVertex), (<span class="type">void</span>*)<span class="built_in">offsetof</span>(ffVertex, m_idArr));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffModel::loadModel</span><span class="params">(std::string _path)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Assimp::Importer _importer;</span><br><span class="line">		<span class="type">const</span> aiScene* _scene = _importer.<span class="built_in">ReadFile</span>(_path, aiProcess_Triangulate | aiProcess_FlipUVs);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!_scene || _scene-&gt;mFlags &amp; AI_SCENE_FLAGS_INCOMPLETE || !_scene-&gt;mRootNode)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;model read fail!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		m_dir = _path.<span class="built_in">substr</span>(<span class="number">0</span>, _path.<span class="built_in">find_last_of</span>(<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">		<span class="built_in">processNode</span>(_scene-&gt;mRootNode, _scene);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffModel::processNode</span><span class="params">(aiNode* _node, <span class="type">const</span> aiScene* _scene)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _node-&gt;mNumMeshes; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			aiMesh* _mesh = _scene-&gt;mMeshes[_node-&gt;mMeshes[i]];</span><br><span class="line">			m_meshVec.<span class="built_in">push_back</span>(<span class="built_in">processMesh</span>(_mesh, _scene, _node, m_skeleton));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _node-&gt;mNumChildren; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">processNode</span>(_node-&gt;mChildren[i], _scene);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">ffMesh <span class="title">ffModel::processMesh</span><span class="params">(aiMesh* _mesh, <span class="type">const</span> aiScene* _scene, <span class="type">const</span> aiNode* _node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		std::vector&lt;ffVertex&gt;	_vertexVec;</span><br><span class="line">		std::vector&lt;uint&gt;		_indexVec;</span><br><span class="line">		std::vector&lt;ffTexture&gt;	_texVec;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _mesh-&gt;mNumVertices; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			ffVertex   _vertex;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//位置信息读取</span></span><br><span class="line">			glm::vec3 _pos;</span><br><span class="line">			_pos.x = _mesh-&gt;mVertices[i].x;</span><br><span class="line">			_pos.y = _mesh-&gt;mVertices[i].y;</span><br><span class="line">			_pos.z = _mesh-&gt;mVertices[i].z;</span><br><span class="line">			_vertex.m_pos = _pos;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//法线</span></span><br><span class="line">			glm::vec3 _normal;</span><br><span class="line">			_normal.x = _mesh-&gt;mNormals[i].x;</span><br><span class="line">			_normal.y = _mesh-&gt;mNormals[i].y;</span><br><span class="line">			_normal.z = _mesh-&gt;mNormals[i].z;</span><br><span class="line">			_vertex.m_normal = _normal;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//纹理坐标</span></span><br><span class="line">			<span class="keyword">if</span> (_mesh-&gt;mTextureCoords[<span class="number">0</span>])</span><br><span class="line">			&#123;</span><br><span class="line">				glm::vec2 _texCoord;</span><br><span class="line">				_texCoord.x = _mesh-&gt;mTextureCoords[<span class="number">0</span>][i].x;</span><br><span class="line">				_texCoord.y = _mesh-&gt;mTextureCoords[<span class="number">0</span>][i].y;</span><br><span class="line">				_vertex.m_texCoord = _texCoord;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			_vertexVec.<span class="built_in">push_back</span>(_vertex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//解析index</span></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _mesh-&gt;mNumFaces; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			aiFace	_face = _mesh-&gt;mFaces[i];</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; _face.mNumIndices; j++)</span><br><span class="line">			&#123;</span><br><span class="line">				_indexVec.<span class="built_in">push_back</span>(_face.mIndices[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//解析材质</span></span><br><span class="line">		<span class="keyword">if</span> (_mesh-&gt;mMaterialIndex &gt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			aiMaterial* _mat = _scene-&gt;mMaterials[_mesh-&gt;mMaterialIndex];</span><br><span class="line"></span><br><span class="line">			std::vector&lt;ffTexture&gt; _diffuseVec = <span class="built_in">loadMaterialTextures</span>(_mat, aiTextureType_DIFFUSE, TEXTURE_DIFFUSE_STR);</span><br><span class="line">			_texVec.<span class="built_in">insert</span>(_texVec.<span class="built_in">end</span>(), _diffuseVec.<span class="built_in">begin</span>(), _diffuseVec.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">			std::vector&lt;ffTexture&gt; _specularVec = <span class="built_in">loadMaterialTextures</span>(_mat, aiTextureType_SPECULAR, TEXTURE_SPECULAR_STR);</span><br><span class="line">			_texVec.<span class="built_in">insert</span>(_texVec.<span class="built_in">end</span>(), _specularVec.<span class="built_in">begin</span>(), _specularVec.<span class="built_in">end</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//解析骨骼动画</span></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _mesh-&gt;mNumBones; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			aiBone* _aiBone = _mesh-&gt;mBones[i];</span><br><span class="line"></span><br><span class="line">			<span class="comment">//给顶点权重及骨骼id</span></span><br><span class="line">			<span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; _aiBone-&gt;mNumWeights; j++)</span><br><span class="line">			&#123;</span><br><span class="line">				aiVertexWeight	_weight = _aiBone-&gt;mWeights[i];</span><br><span class="line">				<span class="keyword">for</span> (uint k = <span class="number">0</span>; k &lt; MAX_BONE_WEIGHT_PER_VERTEX; k++)</span><br><span class="line">				&#123;</span><br><span class="line">					_vertexVec[_weight.mVertexId].m_weightArr[k] = _weight.mWeight;</span><br><span class="line">					_vertexVec[_weight.mVertexId].m_idArr[k] = i;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//解析骨骼构建骨骼</span></span><br><span class="line">			<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _mesh-&gt;mNumBones; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				aiBone* _pBone = _mesh-&gt;mBones[i];</span><br><span class="line">				<span class="keyword">if</span> (!_pBone)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				std::string _boneName = _pBone-&gt;mName.<span class="built_in">C_Str</span>();</span><br><span class="line">				glm::mat4	_boneMatrix = <span class="built_in">AiToGLMMat4</span>(_pBone-&gt;mOffsetMatrix);</span><br><span class="line"></span><br><span class="line">				ffBone _newBone(i, _boneName, _boneMatrix);</span><br><span class="line">				<span class="comment">//_newBone</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ffMesh</span>(_vertexVec, _indexVec, _texVec);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">std::vector&lt;ffTexture&gt;	<span class="title">ffModel::loadMaterialTextures</span><span class="params">(aiMaterial* _mat, aiTextureType _type, std::string _typeName)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		std::vector&lt;ffTexture&gt; _texVec;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _mat-&gt;<span class="built_in">GetTextureCount</span>(_type); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			ffTexture _tex;</span><br><span class="line"></span><br><span class="line">			aiString _path;</span><br><span class="line">			_mat-&gt;<span class="built_in">GetTexture</span>(_type, i, &amp;_path);</span><br><span class="line"></span><br><span class="line">			_tex.m_id = ffTextureMananger::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">createTexture</span>(_path.<span class="built_in">C_Str</span>(), m_dir);</span><br><span class="line">			_tex.m_path = _path.<span class="built_in">C_Str</span>();</span><br><span class="line">			_tex.m_type = _typeName;</span><br><span class="line"></span><br><span class="line">			_texVec.<span class="built_in">push_back</span>(_tex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> _texVec;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ffModel::draw</span><span class="params">(Shader&amp; _shader)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; m_meshVec.<span class="built_in">size</span>(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			m_meshVec[i].<span class="built_in">draw</span>(_shader);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">SINGLE_INSTANCE_SET</span>(ffTextureMananger)</span><br><span class="line"></span><br><span class="line">		<span class="function">uint <span class="title">ffTextureMananger::createTexture</span><span class="params">(std::string _path)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		std::map&lt;std::string, uint&gt;::iterator _it = m_texMap.<span class="built_in">find</span>(_path);</span><br><span class="line">		<span class="keyword">if</span> (_it != m_texMap.<span class="built_in">end</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> _it-&gt;second;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ffImage* _image = ffImage::<span class="built_in">readFromFile</span>(_path.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">		uint _texID = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;_texID);</span><br><span class="line">		<span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _texID);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGBA, _image-&gt;<span class="built_in">getWidth</span>(), _image-&gt;<span class="built_in">getHeight</span>(), <span class="number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, _image-&gt;<span class="built_in">getData</span>());</span><br><span class="line">		<span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</span><br><span class="line">		<span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</span><br><span class="line">		<span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line">		<span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">delete</span> _image;</span><br><span class="line">		m_texMap[_path] = _texID;</span><br><span class="line">		<span class="keyword">return</span> _texID;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">uint <span class="title">ffTextureMananger::createTexture</span><span class="params">(std::string _path, std::string _dir)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">createTexture</span>(_dir + <span class="string">&#x27;/&#x27;</span> + _path);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="DrawCall-减少性能开销"><a href="#DrawCall-减少性能开销" class="headerlink" title="DrawCall 减少性能开销"></a>DrawCall 减少性能开销</h3><p>使用Instance来做 统一将所有渲染任务压入</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">glDrawArraysInstanced</span><span class="params">(GLenum mode, Glint first, GLsizei count, GLsizei primcount)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">glDrawElementsInstanced</span><span class="params">(GLenum mode, GLsizei count, GLenum type, <span class="type">const</span> <span class="type">void</span> * indices, FLsizei primcount)</span></span>; <span class="comment">// primCount 一次性打包绘制的实例数量</span></span><br></pre></td></tr></table></figure>

<h4 id="gl-InstanceID-内置变量"><a href="#gl-InstanceID-内置变量" class="headerlink" title="gl_InstanceID 内置变量"></a>gl_InstanceID 内置变量</h4><p>代表正在绘制的实例编号 从0开始依次递增</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec2</span> aPos;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec3</span> aColor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec3</span> fColor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec2</span> offsets[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">vec2</span> <span class="keyword">offset</span> = <span class="keyword">offset</span>[<span class="built_in">gl_InstanceID</span>];</span><br><span class="line">	<span class="built_in">gl_Position</span> = <span class="type">vec4</span>(aPos + <span class="keyword">offset</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">	fColor = aColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用gl_InstanceID 会导致过多的使用uniform变量</p>
<h4 id="gl-InstanceID-内置变量-优化-InstanceArray"><a href="#gl-InstanceID-内置变量-优化-InstanceArray" class="headerlink" title="gl_InstanceID 内置变量 优化 InstanceArray"></a>gl_InstanceID 内置变量 优化 InstanceArray</h4><p>利用顶点数组VBO进行书传书 VShader中使用layout进行MAT4的获取</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">glGenBuffers(<span class="number">1</span>, &amp;_VBO_ins);</span><br><span class="line">glBindBuffer(GL_ARRAY_BUFFER, VBO_ins);</span><br><span class="line">glBufferData(GL_ARRAY_BUFFER, sizeof(glm::<span class="type">mat4</span>) * AMOUNT, _mMatrixArrp[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line"><span class="comment">// 挂载锚点绑定数据， AttriPointer最多支持vec4，所以拆开</span></span><br><span class="line">glBIndVertexArray(_model-&gt;m_meshVec[i].m_VAO);</span><br><span class="line">glEnableVertexAttribArray(<span class="number">3</span>);</span><br><span class="line">glVertexAttribPointer(<span class="number">3</span>,<span class="number">4</span>,GL_FLOAT,GL_FALSE,sizeof(glm::<span class="type">mat4</span>),(<span class="type">void</span>*)<span class="number">0</span>);</span><br><span class="line">glEnableVertexAttribArray(<span class="number">4</span>);</span><br><span class="line">glVertexAttribPointer(<span class="number">4</span>,<span class="number">4</span>,GL_FLOAT,GL_FALSE,sizeof(glm::<span class="type">mat4</span>),(<span class="type">void</span>*)<span class="number">0</span>(sizeof(glm::<span class="type">vec4</span>));</span><br><span class="line">glEnableVertexAttribArray(<span class="number">5</span>);</span><br><span class="line">glVertexAttribPointer(<span class="number">5</span>,<span class="number">4</span>,GL_FLOAT,GL_FALSE,sizeof(glm::<span class="type">mat4</span>),(<span class="type">void</span>*)<span class="number">0</span>(sizeof(glm::<span class="type">vec4</span>)*<span class="number">2</span>);</span><br><span class="line">glEnableVertexAttribArray(<span class="number">6</span>);</span><br><span class="line">glVertexAttribPointer(<span class="number">6</span>,<span class="number">4</span>,GL_FLOAT,GL_FALSE,sizeof(glm::<span class="type">mat4</span>),(<span class="type">void</span>*)<span class="number">0</span>(sizeof(glm::<span class="type">vec4</span>)*<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h4 id="glVertexAttribDivisor-GLuint-index-GLuint-divisor"><a href="#glVertexAttribDivisor-GLuint-index-GLuint-divisor" class="headerlink" title="glVertexAttribDivisor(GLuint index, GLuint divisor)"></a>glVertexAttribDivisor(GLuint index, GLuint divisor)</h4><p>index：挂载的锚点</p>
<p>divisor：多少个实例迭代一次， 0 代表一个顶点迭代一次， 1代表一个模型实例绘制迭代一次</p>
<h3 id="Instance-实现"><a href="#Instance-实现" class="headerlink" title="Instance 实现"></a>Instance 实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AMOUNT 100000</span></span><br><span class="line"></span><br><span class="line">glm::mat4* _mMatrixArr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">FF::ffModel* _model = <span class="literal">NULL</span>;</span><br><span class="line">uint _VBO_ins;</span><br><span class="line">uint _texId;</span><br><span class="line"></span><br><span class="line">Shader          _shader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Camera          _camera;</span><br><span class="line"></span><br><span class="line">glm::mat4 _projMatrix(<span class="number">1.0f</span>);</span><br><span class="line"><span class="type">int</span>       _width = <span class="number">800</span>;</span><br><span class="line"><span class="type">int</span>       _height = <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glClearColor</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _camera.<span class="built_in">update</span>();</span><br><span class="line">    _projMatrix = glm::<span class="built_in">perspective</span>(glm::<span class="built_in">radians</span>(<span class="number">45.0f</span>), (<span class="type">float</span>)_width / (<span class="type">float</span>)_height, <span class="number">0.1f</span>, <span class="number">100.0f</span>);</span><br><span class="line"></span><br><span class="line">    _shader.<span class="built_in">start</span>();</span><br><span class="line">    _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_viewMatrix&quot;</span>, _camera.<span class="built_in">getMatrix</span>());</span><br><span class="line">    _shader.<span class="built_in">setMatrix</span>(<span class="string">&quot;_projMatrix&quot;</span>, _projMatrix);</span><br><span class="line">    _shader.<span class="built_in">setFloat</span>(<span class="string">&quot;myMaterial.m_shiness&quot;</span>, <span class="number">32.0f</span>);</span><br><span class="line">    _shader.<span class="built_in">setVec3</span>(<span class="string">&quot;view_pos&quot;</span>, _camera.<span class="built_in">getPosition</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//光照设置</span></span><br><span class="line">    _shader.<span class="built_in">setVec3</span>(<span class="string">&quot;myLight.m_pos&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">    _shader.<span class="built_in">setVec3</span>(<span class="string">&quot;myLight.m_ambient&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">0.9f</span>, <span class="number">0.9f</span>, <span class="number">0.9f</span>));</span><br><span class="line">    _shader.<span class="built_in">setVec3</span>(<span class="string">&quot;myLight.m_diffuse&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    _shader.<span class="built_in">setVec3</span>(<span class="string">&quot;myLight.m_specular&quot;</span>, glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>));</span><br><span class="line"></span><br><span class="line">    _shader.<span class="built_in">setFloat</span>(<span class="string">&quot;myLight.c&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    _shader.<span class="built_in">setFloat</span>(<span class="string">&quot;myLight.l&quot;</span>, <span class="number">0.09f</span>);</span><br><span class="line">    _shader.<span class="built_in">setFloat</span>(<span class="string">&quot;myLight.q&quot;</span>, <span class="number">0.032f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, _texId);</span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _model-&gt;m_meshVec.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(_model-&gt;m_meshVec[i].m_VAO);</span><br><span class="line">        <span class="built_in">glDrawElementsInstanced</span>(GL_TRIANGLES, _model-&gt;m_meshVec[i].m_vertexVec.<span class="built_in">size</span>(), GL_UNSIGNED_INT, <span class="number">0</span>, AMOUNT);</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* for (uint i = 0; i &lt; AMOUNT; i++)</span></span><br><span class="line"><span class="comment">     &#123;</span></span><br><span class="line"><span class="comment">         _shader.setMatrix(&quot;_modelMatrix&quot;, _mMatrixArr[i]);</span></span><br><span class="line"><span class="comment">         _model-&gt;draw(_shader);</span></span><br><span class="line"><span class="comment">     &#125;*/</span></span><br><span class="line"></span><br><span class="line">    _shader.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initShader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _shader.<span class="built_in">initShader</span>(<span class="string">&quot;shader/vPointShader.glsl&quot;</span>, <span class="string">&quot;shader/fPointShader.glsl&quot;</span>);</span><br><span class="line">    <span class="comment">//_shader.initShader(&quot;shader/vertexShader.glsl&quot;, &quot;shader/fragmentShader.glsl&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">framebuffer_size_callback</span><span class="params">(GLFWwindow* window, <span class="type">int</span> width, <span class="type">int</span> height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glViewport</span>(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">processInput</span><span class="params">(GLFWwindow* window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_ESCAPE) == GLFW_PRESS)</span><br><span class="line">        <span class="built_in">glfwSetWindowShouldClose</span>(window, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_W) == GLFW_PRESS)</span><br><span class="line">    &#123;</span><br><span class="line">        _camera.<span class="built_in">move</span>(CAMERA_MOVE::MOVE_FRONT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_S) == GLFW_PRESS)</span><br><span class="line">    &#123;</span><br><span class="line">        _camera.<span class="built_in">move</span>(CAMERA_MOVE::MOVE_BACK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_A) == GLFW_PRESS)</span><br><span class="line">    &#123;</span><br><span class="line">        _camera.<span class="built_in">move</span>(CAMERA_MOVE::MOVE_LEFT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_D) == GLFW_PRESS)</span><br><span class="line">    &#123;</span><br><span class="line">        _camera.<span class="built_in">move</span>(CAMERA_MOVE::MOVE_RIGHT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mouse_callback</span><span class="params">(GLFWwindow* window, <span class="type">double</span> xpos, <span class="type">double</span> ypos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _camera.<span class="built_in">onMouseMove</span>(xpos, ypos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initInstanceArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//准备模型变换矩阵</span></span><br><span class="line">    _mMatrixArr = <span class="keyword">new</span> glm::mat4[AMOUNT];</span><br><span class="line">    <span class="built_in">srand</span>(<span class="built_in">glfwGetTime</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> radius = <span class="number">10.0</span>;</span><br><span class="line">    <span class="type">float</span> offset = <span class="number">2.5f</span>;</span><br><span class="line"></span><br><span class="line">    glm::mat4 model = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; AMOUNT; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        glm::mat4 model = glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> angle = (<span class="type">float</span>)i / (<span class="type">float</span>)AMOUNT * <span class="number">360.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> displacement = (<span class="built_in">rand</span>() % (<span class="type">int</span>)(<span class="number">2</span> * offset * <span class="number">100</span>)) / <span class="number">100.0f</span> - offset;</span><br><span class="line">        <span class="type">float</span> x = <span class="built_in">sin</span>(angle) * radius + displacement;</span><br><span class="line">        displacement = (<span class="built_in">rand</span>() % (<span class="type">int</span>)(<span class="number">2</span> * offset * <span class="number">100</span>)) / <span class="number">100.0f</span> - offset;</span><br><span class="line">        <span class="type">float</span> y = displacement * <span class="number">0.4f</span>;</span><br><span class="line">        displacement = (<span class="built_in">rand</span>() % (<span class="type">int</span>)(<span class="number">2</span> * offset * <span class="number">100</span>)) / <span class="number">100.0f</span> - offset;</span><br><span class="line">        <span class="type">float</span> z = <span class="built_in">cos</span>(angle) * radius + displacement;</span><br><span class="line"></span><br><span class="line">        model = glm::<span class="built_in">translate</span>(model, glm::<span class="built_in">vec3</span>(x, y, z));</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> scale = (<span class="built_in">rand</span>() % <span class="number">20</span>) / <span class="number">100.0f</span> + <span class="number">0.05</span>;</span><br><span class="line">        model = glm::<span class="built_in">scale</span>(model, glm::<span class="built_in">vec3</span>(scale));</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> rotAngle = (<span class="built_in">rand</span>() % <span class="number">360</span>);</span><br><span class="line">        model = glm::<span class="built_in">rotate</span>(model, glm::<span class="built_in">radians</span>(rotAngle), glm::<span class="built_in">vec3</span>(<span class="number">0.4f</span>, <span class="number">0.6f</span>, <span class="number">0.8f</span>));</span><br><span class="line"></span><br><span class="line">        _mMatrixArr[i] = model;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;_VBO_ins);</span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, _VBO_ins);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(glm::mat4) * AMOUNT, &amp;_mMatrixArr[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; _model-&gt;m_meshVec.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(_model-&gt;m_meshVec[i].m_VAO);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(<span class="number">3</span>, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(glm::mat4), (<span class="type">void</span>*)<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">4</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(<span class="number">4</span>, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(glm::mat4), (<span class="type">void</span>*)(<span class="built_in">sizeof</span>(glm::vec4)));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(<span class="number">5</span>, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(glm::mat4), (<span class="type">void</span>*)(<span class="built_in">sizeof</span>(glm::vec4) * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(<span class="number">6</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(<span class="number">6</span>, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(glm::mat4), (<span class="type">void</span>*)(<span class="built_in">sizeof</span>(glm::vec4) * <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(<span class="number">5</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(<span class="number">6</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    _texId = FF::ffTextureManager::<span class="built_in">getInstance</span>()-&gt;<span class="built_in">createTexture</span>(<span class="string">&quot;res/rock/rock.png&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glfwInit</span>();</span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MAJOR, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MINOR, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">glfwWindowHint</span>(GLFW_OPENGL_PROFILE, GLFW_OPENGL_COMPAT_PROFILE);</span><br><span class="line"></span><br><span class="line">    GLFWwindow* window = <span class="built_in">glfwCreateWindow</span>(<span class="number">800</span>, <span class="number">600</span>, <span class="string">&quot;OpenGL Core&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (window == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Failed to create GLFW window&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">glfwTerminate</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">glfwMakeContextCurrent</span>(window);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">gladLoadGLLoader</span>((GLADloadproc)glfwGetProcAddress))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Failed to initialize GLAD&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glViewport</span>(<span class="number">0</span>, <span class="number">0</span>, _width, _height);</span><br><span class="line">    <span class="built_in">glfwSetFramebufferSizeCallback</span>(window, framebuffer_size_callback);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">glfwSetInputMode</span>(window, GLFW_CURSOR, GLFW_CURSOR_DISABLED);</span><br><span class="line">    <span class="built_in">glfwSetCursorPosCallback</span>(window, mouse_callback);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _camera.<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">8.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">    _camera.<span class="built_in">setSpeed</span>(<span class="number">0.01f</span>);</span><br><span class="line"></span><br><span class="line">    _model = <span class="keyword">new</span> FF::<span class="built_in">ffModel</span>(<span class="string">&quot;res/rock/rock.obj&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">initInstanceArray</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">initShader</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">glfwWindowShouldClose</span>(window))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">processInput</span>(window);</span><br><span class="line">        <span class="built_in">rend</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glfwSwapBuffers</span>(window);</span><br><span class="line">        <span class="built_in">glfwPollEvents</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">glfwTerminate</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Blin-Phong-光照实现"><a href="#Blin-Phong-光照实现" class="headerlink" title="Blin-Phong 光照实现"></a>Blin-Phong 光照实现</h2><h3 id="半程向量"><a href="#半程向量" class="headerlink" title="半程向量"></a>半程向量</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240815185752239.png" alt="image-20240815185752239" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240815190032563.png" alt="image-20240815190032563" style="zoom:67%;" />

<p>反射光和人眼的夹角大于九十度 导致光线被计算忽略 造成偏差</p>
<h3 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240816171731033.png" alt="image-20240816171731033" style="zoom:67%;" />

<h2 id="Gamma矫正"><a href="#Gamma矫正" class="headerlink" title="Gamma矫正"></a>Gamma矫正</h2><h3 id="显示器亮度与电压的关系"><a href="#显示器亮度与电压的关系" class="headerlink" title="显示器亮度与电压的关系"></a>显示器亮度与电压的关系</h3><p>CRT显示器是通过电压对屏幕亮度进行调节,但是电压的增长与亮度的增长并不是线性相关<br>的关系,大概会是一个2.2次幂的关系</p>
<p>现代的显示器为了兼容CRT也做了一些类似的设置保留</p>
<p>所以如果想显示真实场景就需要校正</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240816145138210.png" alt="image-20240816145138210" style="zoom:50%;" />

<h3 id="SRGB颜色空间"><a href="#SRGB颜色空间" class="headerlink" title="SRGB颜色空间"></a>SRGB颜色空间</h3><p>经过gamma校正后的颜色所构成的颜色空间,即为sRGB颜色空间</p>
<p>颜色：(0.5,0.0,0.0)1&#x2F;2.2&#x3D;(0.5,0.0,0.0)0.45&#x3D;(0.73,0.0,0.0),</p>
<p>那么这个(0.73,0.0,0.0) 即为sRGB颜色空间当中的颜色值了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FUN1：</span><br><span class="line"><span class="comment">// 伽马矫正启用方式</span></span><br><span class="line"><span class="built_in">glEnable</span>(GL_FRAMEBUFFER_SRGB);</span><br><span class="line"><span class="comment">// 函数调用后会再每一个产生出来的Fragment颜色中，使用一次Gamma矫正 将颜色转为sRGB颜色空间的色彩 输出到显示器及进行类似幂运算</span></span><br><span class="line"></span><br><span class="line">FUN2：</span><br><span class="line"><span class="type">float</span> gamma = <span class="number">2.2</span>;</span><br><span class="line">FragColor.rgb = <span class="built_in">pow</span>(fragColor.rgb, <span class="built_in">vec3</span>(<span class="number">1.0</span>/gamma));</span><br><span class="line"><span class="comment">// 直接再Shader当中手动加上Gamma矫正</span></span><br></pre></td></tr></table></figure>

<p>再美术工作中 如果工具软件具有Gamma矫正 会输出SRGB颜色空间的贴图 程序解读后进行Gamma矫正会导致效果和美术生成所看到的效果不同</p>
<p><strong>创作者:rgb — 做一次1&#x2F;2.2次幂(Gamma) —- 美术操作 — 2.2次幂之后 — 正常</strong><br><strong>程序:读入rgb — 做一次2.2次幂 — 做一次1&#x2F;2.2次幂 — 做一次2.2次幂 — 正常</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用纹理图片之前 做一次sRGB到RGB的转换，然后再做后续</span></span><br><span class="line"><span class="type">float</span> gamma = <span class="number">2.2</span>;</span><br><span class="line">vec3 diffuseColor = <span class="built_in">pow</span>(<span class="built_in">texture</span>(diffuse, texCoords).rgb, <span class="built_in">vec3</span>(gamma));</span><br></pre></td></tr></table></figure>

<p>glTexlmage2D(GL_TEXTURE_2D, 0, GL_SRGB, width, height, 0, GL_RGB, GL_UNSIGNED_BYTE, data);</p>
<p>可以如此接口使用,在图片读进来的时候,就设置internalFormat为sRGB空间,然后会被openGL<br>自动转化为2.2次幂,之后就可以使用, 场景变得柔和</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240816144451807.png" alt="image-20240816144451807" style="zoom:67%;" />

<h2 id="ShadowMapping"><a href="#ShadowMapping" class="headerlink" title="ShadowMapping"></a>ShadowMapping</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240816180358159.png" alt="image-20240816180358159" style="zoom:67%;" />

<h3 id="平行光"><a href="#平行光" class="headerlink" title="平行光"></a>平行光</h3><h3 id="深度渲染-FrameBuffer"><a href="#深度渲染-FrameBuffer" class="headerlink" title="深度渲染 FrameBuffer"></a>深度渲染 FrameBuffer</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> depthMapFBO;</span><br><span class="line"><span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;depthMapFBO);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> SHADOW_WIDTH = <span class="number">1024</span>, SHADOW_HEIGHT = <span class="number">1024</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> depthMap;</span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;depthMap);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, depthMap);</span><br><span class="line"><span class="built_in">glTexlmage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH_COMPONENT,SHADOW_WIDTH, SHADOW_HEIGHT, <span class="number">0</span>, GL_DEPTH_COMPONENT, GL_FLOAT, <span class="literal">NULL</span>); <span class="comment">// shadow Texture</span></span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);</span><br><span class="line"></span><br><span class="line"><span class="comment">// bind</span></span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, depthMapFBO);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, depthMap, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">glDrawBuffer</span>(GL_NONE);</span><br><span class="line"><span class="built_in">glReadBuffer</span>(GL_NONE);</span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="FragmentShader-阴影部分（Pass2）"><a href="#FragmentShader-阴影部分（Pass2）" class="headerlink" title="FragmentShader 阴影部分（Pass2）"></a>FragmentShader 阴影部分（Pass2）</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line">[ -- datas -- ]</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> shadowMap;	<span class="comment">// 对应depthMap 找到各个点深度值</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> ShadowCalculation(<span class="type">vec4</span> fragPosLightSpace)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec3</span> projCoords = fragPosLightSpace.xyz / fragPosLightSpace.w; <span class="comment">// 得到NDC</span></span><br><span class="line">    projCoords = projCoords * <span class="number">0.5</span> + <span class="number">0.5</span>; <span class="comment">// 转化为0到1</span></span><br><span class="line">    <span class="type">float</span> closestDepth = <span class="built_in">texture</span>(shadowMap, projCoords.xy).r; <span class="comment">// (X,Y为U,V  r为Z)</span></span><br><span class="line">    <span class="type">float</span> currentDepth = projCoords.z;</span><br><span class="line">    <span class="type">float</span> shadow = currentDepth &gt; closestDepth ? <span class="number">1.0</span> : <span class="number">0.0</span>; <span class="comment">// 是否产生阴影</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shadow;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    [ -- calculate Light --- ]</span><br><span class="line">    <span class="comment">// calculate shadow</span></span><br><span class="line">    <span class="type">float</span> shadow = ShadowCalculation(fs_in.FragPosLightSpace); <span class="comment">// fs_in.FragPosLightSpace 所渲染物体在光源空间的坐标 类NDC 除W成为NDC (Position * MVP)</span></span><br><span class="line">    <span class="type">vec3</span> lighting = (ambient + (<span class="number">1.0</span> - shadow) * (diffuse + specular)) * color;</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(lighting, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819103219491.png" alt="image-20240819103219491" style="zoom:67%;" />

<h3 id="ShadowAnce-噪声-（采样不均问题）"><a href="#ShadowAnce-噪声-（采样不均问题）" class="headerlink" title="ShadowAnce 噪声 （采样不均问题）"></a>ShadowAnce 噪声 （采样不均问题）</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819103738356.png" alt="image-20240819103738356" style="zoom:67%;" />

<p>深度差别太小 导致a通过测试 b未通过测试 a亮 b暗 明暗交替</p>
<h3 id="Bias参数去噪"><a href="#Bias参数去噪" class="headerlink" title="Bias参数去噪"></a>Bias参数去噪</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819104053607.png" alt="image-20240819104053607"  />

<p>同样但也会导致之前该是阴影的部分抬升</p>
<h3 id="Peter-Panning-去噪"><a href="#Peter-Panning-去噪" class="headerlink" title="Peter Panning 去噪"></a>Peter Panning 去噪</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819105405513.png" alt="image-20240819105405513" style="zoom: 67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819105749325.png" alt="image-20240819105749325" style="zoom:50%;" />

<h3 id="过采样问题"><a href="#过采样问题" class="headerlink" title="过采样问题"></a>过采样问题</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819115445534.png" alt="image-20240819115445534" style="zoom:67%;" />

<p>XY超出立方体的点处理方式 ：使用GL_CLAMP_TO_BORDER的过采样方式，让出界的都采样到1.0的深度</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">glTexParameteri(GL_TEXTURE_2D, GL_TExTURE_WARP_S, GL_CLAMP_TO_BORDER);</span><br><span class="line">glTexParameteri(GL_TEXTURE_2D, GL_TExTURE_WARP_T, GL_CLAMP_TO_BORDER);</span><br><span class="line"><span class="type">float</span> borderColor[] = &#123;<span class="number">1</span>,<span class="number">0</span>f. <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f&#125;;</span><br><span class="line">glTexParameterfv(GL_TEXTURE_2D, GL_TEXTURE_BORDER_COLOR, borderColor);</span><br></pre></td></tr></table></figure>

<h3 id="阴影锯齿问题"><a href="#阴影锯齿问题" class="headerlink" title="阴影锯齿问题"></a>阴影锯齿问题</h3><p>深度贴图分辨率有限 采样密度不够</p>
<h3 id="PCF-percentage-closer-filtering"><a href="#PCF-percentage-closer-filtering" class="headerlink" title="PCF-percentage-closer filtering"></a>PCF-percentage-closer filtering</h3><p>最简单的方式  多顶当前要处理的Fragment对应的深度贴图 Texel，使用周围八个Texel进行平均</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> shadow = <span class="number">0.0</span>;</span><br><span class="line"><span class="type">vec2</span> texelSize = <span class="number">1.0</span> / <span class="built_in">textureSize</span>(shadowMap, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> x =- <span class="number">1</span>; x &lt;= <span class="number">1</span>; ++x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> y =- <span class="number">1</span>; y &lt;= <span class="number">1</span>; ++y)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">float</span> pcfDepth = <span class="built_in">texture</span>(shadowMap, projCoords.xy + <span class="type">vec2</span>(x, y) * texelSize).r;</span><br><span class="line">    	shadow += currentDepth - bias &gt; pcfDepth ? <span class="number">1.0</span> : <span class="number">0.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shadow /= <span class="number">9.0</span>;</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819122032730.png" alt="image-20240819122032730" style="zoom:67%;" />

<h2 id="PointShadow"><a href="#PointShadow" class="headerlink" title="PointShadow"></a>PointShadow</h2><p>单一光源方向并不足够 房间中的光照需要优化</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819153312161.png" alt="image-20240819153312161" style="zoom:50%;" />

<p>每个面对应一个90度的视场角（FOV），覆盖场景的一个特定方向：前（+X），后（-X），左（-Y），右（+Y），上（+Z），下（-Z）。每个面都可以使用一个标准的透视投影矩阵进行渲染，FOV通常设置为90度，以确保没有任何失真或间隙。</p>
<p><strong>首先可以想到为光源的6个方向做6个光照矩阵 6次渲染得到6张深度贴图，进行pass2</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">glFramebufferTexture</span>(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, textures[i], <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">BindViewMatrix</span>(lightViewMatrices[i]);</span><br><span class="line">    <span class="built_in">RenderScene</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h3><ul>
<li>问题描述:我们需要渲染六张图,为什么必须要做六次渲染流程呢?主要是每次都需要虚拟一个光照矩阵(ViewMatrix*ProjMatrix),然后这六个光照矩阵分别跟Vertex相乘做变换,分别渲染</li>
<li>设想:对每个三角形来讲,有没有可能通过一次流程,传入六个光照矩阵,对每个三角形进行六次变换,输出六个三角形</li>
<li>解决:可以通过GeometryShader可以将一个三角形输入做成6个三角形图源输出给FS</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819154309044.png" alt="image-20240819154309044"></p>
<ul>
<li><p>问题描述:我们在FS里拿到了六个三角形的数据(分别对应六个光照矩阵以及六个阴影深度贴图),那么我们如何指定哪个三角形渲染到哪个贴图呢?</p>
</li>
<li><p>结论:在GS里,有一个内置变量,叫做gl_Layer,它可以在GS里配合每个输出的图元(三角形),  指定输送给编号为几的Texture,但是只能对CubeMap这种类型管用</p>
</li>
<li><p>问题描述:我现在手里有六个面的六张深度贴图,当我进行真正渲染的时候,需要知道哪个Fragment到底去哪个贴图里读取深度,一般是跟光线连线,然后看看指向哪个面。BUT!太复杂了</p>
</li>
<li><p>结论:对于六个面取纹理这个问题,CubeMap就很好地解决了呀!将光源与当前需要渲染的Fragment位置连一条向量,用这个向量直接作为STR坐标对CubeMap进行采样即可</p>
</li>
</ul>
<h3 id="阴影渲染流程"><a href="#阴影渲染流程" class="headerlink" title="阴影渲染流程"></a>阴影渲染流程</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819154855533.png" alt="image-20240819154855533" style="zoom:67%;" />

<h2 id="CubeMap坐标原理"><a href="#CubeMap坐标原理" class="headerlink" title="CubeMap坐标原理"></a>CubeMap坐标原理</h2><p>在二维图像纹理中 如果直接读入一张图显示会出现上下翻转。图片的（0，0）在左上角，</p>
<p>OpenGL的UV（0，0）在左下角 读入图片生成纹理之前需要在y反向做翻转</p>
<p>在CubeMap中并没有上下翻转</p>
<p>有一个向量R(xyz),如果使用这个R向当前的CubeMap进行采样,那么是如何被翻译到某一个<br>Texture的uv上面呢?</p>
<p>1首先我们看下在R的每个分量当中,绝对值最大的是哪个,比如是x绝对值最大,并且x还<br>是正数,那就说明要冲POSITIVE_x这个Texture进行取值</p>
<p>2计算uv坐标,此时由于冲着x正方向,那么u&#x3D;z,v&#x3D;y,一横一竖,但是这里就有问题了!</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819161652360.png" alt="image-20240819161652360"></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819163147214.png" alt="image-20240819163147214" style="zoom: 50%;" />

<h2 id="法线贴图-TBN空间推导"><a href="#法线贴图-TBN空间推导" class="headerlink" title="法线贴图 &amp; TBN空间推导"></a>法线贴图 &amp; TBN空间推导</h2><p>如何做出物体表面凹凸不平的效果</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240819163345320.png" alt="image-20240819163345320" style="zoom:67%;" />

<p>真实的物体表面应该是粗糙的，几乎每一个Fragment之间的法线都会有所不同</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\edmen\AppData\Roaming\Typora\typora-user-images\image-20240820122310435.png" alt="image-20240820122310435" style="zoom:67%;" />



<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820141840317.png" alt="image-20240820141840317"></p>
<p>把一张法线贴图做成一个以（0，0）为UV点为原点的笛卡尔坐标系，指向外部的向量N为每个Fragment各自的法向量 按照右手坐标系法则求剩下的TB值 如果N看作坐标系Z轴 B为Y轴T为X轴 每一个法线RGB都可以是坐标系中的向量。</p>
<h3 id="TBN-空间转换"><a href="#TBN-空间转换" class="headerlink" title="TBN 空间转换"></a>TBN 空间转换</h3><p>我们目前做出来了一组切线空间的正交基,目前存在两个选择:</p>
<p>1在每一个FragmentShader的执行周期,将每一个法线贴图的normal转换到世界坐标系</p>
<p>2将每一个相关变量都转换到TBN坐标空间,然后与法线贴图的normal进行计算</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VS</span></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec3</span> T = <span class="built_in">normalize</span>(<span class="type">vec3</span>(model * <span class="type">vec4</span>(aTangent, <span class="number">0.0</span>)));</span><br><span class="line">    <span class="type">vec3</span> B = <span class="built_in">normalize</span>(<span class="type">vec3</span>(model * <span class="type">vec4</span>(aBitangent, <span class="number">0.0</span>)));</span><br><span class="line">    <span class="type">vec3</span> N = <span class="built_in">normalize</span>(<span class="type">vec3</span>(model * <span class="type">vec4</span>(aNormal, <span class="number">0.0</span>)));</span><br><span class="line">    <span class="type">mat3</span> TBN = <span class="type">mat3</span>(T, B, N);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FS</span></span><br><span class="line">normal = <span class="built_in">texture</span>(normalMap, fs_in.TexCoords).rgb;</span><br><span class="line">normal = normal * <span class="number">2.0</span> - <span class="number">1.0</span>;</span><br><span class="line">normal = <span class="built_in">normalize</span>(fs_in.TBN * normal);</span><br></pre></td></tr></table></figure>

<h2 id="HDR颜色空间"><a href="#HDR颜色空间" class="headerlink" title="HDR颜色空间"></a>HDR颜色空间</h2><p>OpenGL 系统会把超过1的颜色切位1 如果Frag颜色大于1的过多 就会过度曝光</p>
<p>如果场景当中有很多灯光,且彼此差距很大,那么很容易造成某<br>些Fragment亮度过高。我们有两个处理方式:</p>
<ul>
<li>调整场景当中光源的强度,使得大部分的Fragment颜色值不会超过1,但是会让场景无法表达本来的信息</li>
<li>允许场景当中存在超过1的颜色值,但是在最后输出颜色的时候, 做统一的转换计算,转换到o-1,从而能够更大程度的保持场景当中的颜色信息</li>
</ul>
<p>HDR(High Dynamic range)颜色空间方式,允许颜色值大于1的存在</p>
<p>HDR最早用于摄影的曝光拍摄,通过更多的接受光照,从而能够揭示出来光照较少部分的细节</p>
<h3 id="HDR-FloatingPoint-Buffers"><a href="#HDR-FloatingPoint-Buffers" class="headerlink" title="HDR-FloatingPoint Buffers"></a>HDR-FloatingPoint Buffers</h3><p>此时我们假设渲染到某个Framebuffer上面</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, colorBuffer);</span><br><span class="line"><span class="built_in">glTexlmage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGBA16F, SCR_WIDTH, SCR_HEIGHT, <span class="number">0</span>, GL_RGBA, GL_FLOAT, <span class="literal">NULL</span>); <span class="comment">// 为colorBuffer的texture建立GL_RGBA16F通道</span></span><br></pre></td></tr></table></figure>

<p>这里对于一个像素的RGBA值,每个通道使用一个GL_Float存储,并且每个分量占有16bits即2字节</p>
<p>当然如果我们精度要求很高,可以使用GL_RGBA32F,即一个通道32位,4字节。</p>
<h3 id="HDR-toneMapping"><a href="#HDR-toneMapping" class="headerlink" title="HDR toneMapping"></a>HDR toneMapping</h3><p>将颜色从HDR颜色空间转到RGB0-1颜色空间的过程称为toneMapping</p>
<p>如果简单的把HDR空间的颜色线性的映射到RGB空间,根本不会有任何的意义,反而光线暗的地方更加看不到了</p>
<p>我们必须要用其他的变换公式来进行二者之间的映射</p>
<h4 id="Reinhard-tone-mapping"><a href="#Reinhard-tone-mapping" class="headerlink" title="Reinhard tone mapping"></a>Reinhard tone mapping</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820145325096.png" alt="image-20240820145325096" style="zoom:67%;" />

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reinhard tone mapping</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> hdrBuffer;</span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec3</span> hdrColor = <span class="built_in">texture</span>(hdrBuffer, TexCoords).rgb;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> mapped = hdrColor / (hdrColor + <span class="type">vec3</span>(<span class="number">1.0</span>));</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(mapped, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Exposure-tone-mapping"><a href="#Exposure-tone-mapping" class="headerlink" title="Exposure tone mapping"></a>Exposure tone mapping</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820145559687.png" alt="image-20240820145559687" style="zoom:80%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820145517202.png" alt="image-20240820145517202" style="zoom:67%;" />

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> exposure;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> hdrColor = <span class="built_in">texture</span>(hdrBuffer, TexCoords).rgb;</span><br><span class="line"></span><br><span class="line">    <span class="type">vec3</span> mapped = <span class="type">vec3</span>(<span class="number">1.0</span>) - <span class="built_in">exp</span>(-hdrColor * exposure);</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(mapped, <span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bloom-效果"><a href="#Bloom-效果" class="headerlink" title="Bloom 效果"></a>Bloom 效果</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820150636497.png" alt="image-20240820150636497" style="zoom:67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820150006441.png" alt="image-20240820150006441" style="zoom:67%;" />

<h3 id="Bloom-基础做法"><a href="#Bloom-基础做法" class="headerlink" title="Bloom 基础做法"></a>Bloom 基础做法</h3><ol>
<li><p>将场景渲染出来到FBO的colorBufferA</p>
</li>
<li><p>将灯光单独抠图出来渲染到FBO的colorBufferB</p>
</li>
<li><p>将灯光Texture单独做模糊</p>
</li>
<li><p>将Bloom灯光图合并到主场景Texture中</p>
</li>
</ol>
<h3 id="光源边界问题界定"><a href="#光源边界问题界定" class="headerlink" title="光源边界问题界定"></a>光源边界问题界定</h3><p>我们如何界定Texture当中哪些像素是代表着光源呢?如果我们认定大于某个值为光源,那么万一遇到白色物体如何决定？</p>
<p>解决:在渲染的时候使用HDR颜色空间,就可以将光源设置成为大于1的颜色值, 使得光源颜色与其它物体颜色差距变大</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lightColors.push_back(glm :: <span class="type">vec3</span>(<span class="number">5.0</span>f, <span class="number">5.0</span>f, <span class="number">5.0</span>f));</span><br><span class="line">lightColors.push_back(glm :: <span class="type">vec3</span>(<span class="number">10.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f));</span><br><span class="line">lightColors.push_back(glm :: <span class="type">vec3</span>(<span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">15.0</span>f));</span><br><span class="line">lightColors.push_back(glm :: <span class="type">vec3</span>(<span class="number">0.0</span>f, <span class="number">5.0</span>f, <span class="number">0.0</span>f));</span><br></pre></td></tr></table></figure>

<h3 id="MRT技术"><a href="#MRT技术" class="headerlink" title="MRT技术"></a>MRT技术</h3><p>如何一个PASS完成两个任务:将场景渲染到colorBufferA,将灯光渲染到colorBufferB,并且希望使用同一个FBO</p>
<p>解决:使用MRT技术,即(Multiple Render Target)。在FBO当中,存在多个ColorAttachment选项,我们<br>可以启动两个Color附件,在FS当中对这两个目标进行渲染。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> hdrFBO;</span><br><span class="line"><span class="built_in">glGenFramebufrers</span>(<span class="number">1</span>, &amp;hdrFBO);</span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, hdrFBO);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> colorBuffers[<span class="number">2</span>];</span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">2</span>, colorBuffers);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line"></span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, colorBuffers[i]);</span><br><span class="line"><span class="built_in">glTexlmage2D</span>(</span><br><span class="line">GL_TEXTURE_2D, <span class="number">0</span>, GL_RGBA16F, SCR_WIDTH, SCR_HEIGHT, <span class="number">0</span>, GL_RGBA, GL_FLOAT, <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(</span><br><span class="line">    GL_FRAMEBUFFER, GL_COLOR_ATTACHMENTO + i, GL_TEXTURE_2D, colorBuffers[i], <span class="number">0</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>将两个绘制ColorBuffer目标， 绑定到FS的两个锚定位置</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">unsigned <span class="type">int</span> attachments[<span class="number">2</span>] = &#123; GL_COLOR_ATTACHMENTO, GL_COLOR_ATTACHMENT1 &#125;;</span><br><span class="line">glDrawBuffers(<span class="number">2</span>, attachments);</span><br><span class="line">    <span class="meta">#version 330 core</span></span><br><span class="line">    <span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line">    <span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">out</span> <span class="type">vec4</span> BrightColor;</span><br><span class="line">    <span class="keyword">uniform</span> <span class="type">vec3</span> lighting;</span><br><span class="line">    <span class="type">void</span> main()</span><br><span class="line"></span><br><span class="line">    FragColor = XXXX</span><br><span class="line">    <span class="type">float</span> brightness = <span class="built_in">dot</span>(FragColor.rgb, <span class="type">vec3</span>(<span class="number">0.2126</span>, <span class="number">0.7152</span>, <span class="number">0.0722</span>));</span><br><span class="line">    <span class="keyword">if</span>(brightness &gt; <span class="number">1.0</span>)</span><br><span class="line">    BrightColor = <span class="type">vec4</span>(FragColor.rgb, <span class="number">1.0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    BrightColor = <span class="type">vec4</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现效果-1"><a href="#实现效果-1" class="headerlink" title="实现效果"></a>实现效果</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820173747275.png" alt="image-20240820173747275" style="zoom:67%;" />

<h2 id="高斯模糊"><a href="#高斯模糊" class="headerlink" title="高斯模糊"></a>高斯模糊</h2><p>拆分降低复杂度</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820152521324.png" alt="image-20240820152521324" style="zoom: 67%;" />

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820153609709.png" alt="image-20240820153609709" style="zoom:67%;" />

<h3 id="高斯-Shader"><a href="#高斯-Shader" class="headerlink" title="高斯 Shader"></a>高斯 Shader</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">bool</span> horizontal;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> weight[<span class="number">5</span>] = <span class="type">float</span>[] (<span class="number">0.227027</span>, <span class="number">0.1945946</span>, <span class="number">0.1216216</span>, <span class="number">0.054054</span>, <span class="number">0.016216</span>);</span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">vec2</span> tex_offset = <span class="number">1.0</span> / <span class="built_in">textureSize</span>(image, <span class="number">0</span>); <span class="comment">// gets size of single texel</span></span><br><span class="line">    <span class="type">vec3</span> result = <span class="built_in">texture</span>(image, TexCoords).rgb * weight[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(horizontal) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">        result += <span class="built_in">texture</span>(image, TexCoords + <span class="type">vec2</span>(tex_offset.x * i, <span class="number">0.0</span>)).rgb * weight[i];</span><br><span class="line">        result += <span class="built_in">texture</span>(image, TexCoords - <span class="type">vec2</span>(tex_offset.x * i, <span class="number">0.0</span>)).rgb * weight[i];</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; ++i)&#123;</span><br><span class="line">        result += <span class="built_in">texture</span>(image, TexCoords + <span class="type">vec2</span>(<span class="number">0.0</span>, tex_offset.y * i)).rgb * weight[i];</span><br><span class="line">        result += <span class="built_in">texture</span>(image, TexCoords - <span class="type">vec2</span>(<span class="number">0.0</span>, tex_offset.y * i)).rgb * weight[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	FragColor = <span class="type">vec4</span>(result, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> horizontal = <span class="literal">true</span>, first_iteration = <span class="literal">true</span>;</span><br><span class="line"><span class="type">int</span> amount = <span class="number">10</span>;</span><br><span class="line">shaderBlur.<span class="built_in">use</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, pingpongFBO[horizontal]);</span><br><span class="line">    shaderBlur.<span class="built_in">setInt</span>(<span class="string">&quot;horizontal&quot;</span>, horizontal);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(</span><br><span class="line">    GL_TEXTURE_2D, first_iteration ? colorBuffers[<span class="number">1</span>] : pingpongBuffers[!horizontal]</span><br><span class="line">	);</span><br><span class="line">    <span class="built_in">RenderQuad</span>();</span><br><span class="line">    horizontal = !horizontal;</span><br><span class="line">    <span class="keyword">if</span> (first_iteration)</span><br><span class="line">    	first_iteration = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h2 id="延迟渲染技术"><a href="#延迟渲染技术" class="headerlink" title="延迟渲染技术"></a>延迟渲染技术</h2><h3 id="G缓冲"><a href="#G缓冲" class="headerlink" title="G缓冲"></a>G缓冲</h3><p>G缓冲(G-buffer)是对所有用来储存光照相关的数据，并在最后的光照处理阶段中使用的所有纹理的总称。</p>
<h4 id="正向渲染中照亮一个片段所需要的所有数据"><a href="#正向渲染中照亮一个片段所需要的所有数据" class="headerlink" title="正向渲染中照亮一个片段所需要的所有数据"></a>正向渲染中照亮一个片段所需要的所有数据</h4><ul>
<li>一个3D<strong>位置</strong>向量来计算(插值)片段位置变量供<code>lightDir</code>和<code>viewDir</code>使用</li>
<li>一个RGB漫反射<strong>颜色</strong>向量，也就是反照率(Albedo)</li>
<li>一个3D<strong>法</strong>向量来判断平面的斜率</li>
<li>一个镜面强度(Specular Intensity)浮点值</li>
<li>所有光源的位置和颜色向量</li>
<li>玩家或者观察者的位置向量</li>
</ul>
<p><strong>正向渲染(Forward Rendering)<strong>或者</strong>正向着色法(Forward Shading)<strong>，它是我们渲染物体的一种非常直接的方式，在场景中我们根据所有光源照亮一个物体，之后再渲染下一个物体，以此类推。它非常容易理解，也很容易实现，但是同时它对程序性能的影响也很大，因为对于每一个需要渲染的物体，程序都要对每一个光源每一个需要渲染的片段进行迭代，这是</strong>非常</strong>多的！因为大部分片段着色器的输出都会被之后的输出覆盖，正向渲染还会在场景中因为高深的复杂度(多个物体重合在一个像素上)浪费大量的片段着色器运行时间。</p>
<p>**延迟着色法(Deferred Shading)<strong>，</strong>或者说是延迟渲染(Deferred Rendering)**，为了解决上述问题而诞生了，它大幅度地改变了我们渲染物体的方式。这给我们优化拥有大量光源的场景提供了很多的选择，因为它能够在渲染上百甚至上千光源的同时还能够保持能让人接受的帧率。</p>
<p>**延迟(Defer)<strong>或</strong>推迟(Postpone)**大部分计算量非常大的渲染(像是光照)到后期进行处理的想法。它包含两个处理阶段(Pass)：在第一个几何处理阶段(Geometry Pass)中，我们先渲染场景一次，之后获取对象的各种几何信息，并储存在一系列叫做G缓冲(G-buffer)的纹理中；想想位置向量(Position Vector)、颜色向量(Color Vector)、法向量(Normal Vector)和&#x2F;或镜面值(Specular Value)。场景中这些储存在G缓冲中的几何信息将会在之后用来做(更复杂的)光照计算。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/deferred_overview.png" alt="img"></p>
<p>保证在G缓冲中的片段和在屏幕上呈现的像素所包含的片段信息是一样的，因为深度测试已经最终将这里的片段信息作为最顶层的片段。这样保证了对于在光照处理阶段中处理的每一个像素都只处理一次，所以我们能够省下很多无用的渲染调用。除此之外，延迟渲染还允许我们做更多的优化，从而渲染更多的光源。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(...) <span class="comment">// 游戏循环</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 几何处理阶段：渲染所有的几何/颜色数据到G缓冲 </span></span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, gBuffer);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">    gBufferShader.<span class="built_in">Use</span>();</span><br><span class="line">    <span class="keyword">for</span>(Object obj : Objects)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ConfigureShaderTransformsAndUniforms</span>();</span><br><span class="line">        obj.<span class="built_in">Draw</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 2. 光照处理阶段：使用G缓冲计算场景的光照</span></span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line">    lightingPassShader.<span class="built_in">Use</span>();</span><br><span class="line">    <span class="built_in">BindAllGBufferTextures</span>();</span><br><span class="line">    <span class="built_in">SetLightingUniforms</span>();</span><br><span class="line">    <span class="built_in">RenderQuad</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于几何渲染处理阶段，我们首先需要初始化一个帧缓冲对象，我们很直观的称它为<code>gBuffer</code>，它包含了多个颜色缓冲和一个单独的深度渲染缓冲对象(Depth Renderbuffer Object)。对于位置和法向量的纹理，我们希望使用高精度的纹理(每分量16或32位的浮点数)，而对于反照率和镜面值，使用默认的纹理(每分量8位浮点数)就够了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/deferred_g_buffer.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GLuint gBuffer;</span><br><span class="line"><span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;gBuffer);</span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, gBuffer);</span><br><span class="line">GLuint gPosition, gNormal, gColorSpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 位置颜色缓冲</span></span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;gPosition);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gPosition);</span><br><span class="line"><span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGB16F, SCR_WIDTH, SCR_HEIGHT, <span class="number">0</span>, GL_RGB, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, gPosition, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// - 法线颜色缓冲</span></span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;gNormal);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gNormal);</span><br><span class="line"><span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGB16F, SCR_WIDTH, SCR_HEIGHT, <span class="number">0</span>, GL_RGB, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT1, GL_TEXTURE_2D, gNormal, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 颜色 + 镜面颜色缓冲</span></span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;gAlbedoSpec);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gAlbedoSpec);</span><br><span class="line"><span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGBA, SCR_WIDTH, SCR_HEIGHT, <span class="number">0</span>, GL_RGBA, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT2, GL_TEXTURE_2D, gAlbedoSpec, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 告诉OpenGL我们将要使用(帧缓冲的)哪种颜色附件来进行渲染</span></span><br><span class="line">GLuint attachments[<span class="number">3</span>] = &#123; GL_COLOR_ATTACHMENT0, GL_COLOR_ATTACHMENT1, GL_COLOR_ATTACHMENT2 &#125;;</span><br><span class="line"><span class="built_in">glDrawBuffers</span>(<span class="number">3</span>, attachments);</span><br></pre></td></tr></table></figure>

<h3 id="延迟光照处理"><a href="#延迟光照处理" class="headerlink" title="延迟光照处理"></a>延迟光照处理</h3><p>现在我们已经有了一大堆的片段数据储存在G缓冲中供我们处置，我们可以选择通过一个像素一个像素地遍历各个G缓冲纹理，并将储存在它们里面的内容作为光照算法的输入，来完全计算场景最终的光照颜色。由于所有的G缓冲纹理都代表的是最终变换的片段值，我们只需要对每一个像素执行一次昂贵的光照运算就行了。这使得延迟光照非常高效，特别是在需要调用大量重型片段着色器的复杂场景中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">shaderLightingPass.<span class="built_in">Use</span>();</span><br><span class="line"><span class="built_in">glActiveTexture</span>(GL_TEXTURE0);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gPosition);</span><br><span class="line"><span class="built_in">glActiveTexture</span>(GL_TEXTURE1);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gNormal);</span><br><span class="line"><span class="built_in">glActiveTexture</span>(GL_TEXTURE2);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, gAlbedoSpec);</span><br><span class="line"><span class="comment">// 同样发送光照相关的uniform</span></span><br><span class="line"><span class="built_in">SendAllLightUniformsToShader</span>(shaderLightingPass);</span><br><span class="line"><span class="built_in">glUniform3fv</span>(<span class="built_in">glGetUniformLocation</span>(shaderLightingPass.Program, <span class="string">&quot;viewPos&quot;</span>), <span class="number">1</span>, &amp;camera.Position[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">RenderQuad</span>();  </span><br></pre></td></tr></table></figure>

<p>在渲染之前绑定了G缓冲中所有相关的纹理，并且发送光照相关的uniform变量到着色器中</p>
<h4 id="Shader-1"><a href="#Shader-1" class="headerlink" title="Shader"></a>Shader</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> FragColor;</span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> TexCoords;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gPosition;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gNormal;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> gAlbedoSpec;</span><br><span class="line"></span><br><span class="line">struct Light &#123;</span><br><span class="line">    <span class="type">vec3</span> Position;</span><br><span class="line">    <span class="type">vec3</span> Color;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="type">int</span> NR_LIGHTS = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">uniform</span> Light lights[NR_LIGHTS];</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> viewPos;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;             </span><br><span class="line">    <span class="comment">// 从G缓冲中获取数据</span></span><br><span class="line">    <span class="type">vec3</span> FragPos = <span class="built_in">texture</span>(gPosition, TexCoords).rgb;</span><br><span class="line">    <span class="type">vec3</span> Normal = <span class="built_in">texture</span>(gNormal, TexCoords).rgb;</span><br><span class="line">    <span class="type">vec3</span> Albedo = <span class="built_in">texture</span>(gAlbedoSpec, TexCoords).rgb;</span><br><span class="line">    <span class="type">float</span> Specular = <span class="built_in">texture</span>(gAlbedoSpec, TexCoords).a;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 然后和往常一样地计算光照</span></span><br><span class="line">    <span class="type">vec3</span> lighting = Albedo * <span class="number">0.1</span>; <span class="comment">// 硬编码环境光照分量</span></span><br><span class="line">    <span class="type">vec3</span> viewDir = <span class="built_in">normalize</span>(viewPos - FragPos);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_LIGHTS; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 漫反射</span></span><br><span class="line">        <span class="type">vec3</span> lightDir = <span class="built_in">normalize</span>(lights[i].Position - FragPos);</span><br><span class="line">        <span class="type">vec3</span> diffuse = <span class="built_in">max</span>(<span class="built_in">dot</span>(Normal, lightDir), <span class="number">0.0</span>) * Albedo * lights[i].Color;</span><br><span class="line">        lighting += diffuse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FragColor = <span class="type">vec4</span>(lighting, <span class="number">1.0</span>);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="结合延迟渲染与正向渲染"><a href="#结合延迟渲染与正向渲染" class="headerlink" title="结合延迟渲染与正向渲染"></a>结合延迟渲染与正向渲染</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/29326213f45ed4535652ccf86125c7bb9f2d863ebe3482baba961d315524fd28.png" alt="缩略图"></p>
<p>在延迟渲染方形之上正向渲染所有的光源 正常情况下渲染立方体，只是会在我们完成延迟渲染操作之后进行</p>
<p>首先复制出在几何渲染阶段中储存的深度信息，并输出到默认的帧缓冲的深度缓冲，然后我们才渲染光立方体。这样之后只有当它在之前渲染过的几何体上方的时候，光立方体的片段才会被渲染出来。我们可以使用<code>glBlitFramebuffer</code>复制一个帧缓冲的内容到另一个帧缓冲中，用来还原多重采样的帧缓冲。<code>glBlitFramebuffer</code>这个函数允许我们复制一个用户定义的帧缓冲区域到另一个用户定义的帧缓冲区域。</p>
<h2 id="光的体积渲染"><a href="#光的体积渲染" class="headerlink" title="光的体积渲染"></a>光的体积渲染</h2><p>问题:如果场景当中存在多个光源,那么即便是使用延迟渲染,那么也会出现每个Fragment跟每个光产生一次渲染的性能问题!</p>
<p>我们能不能对每个光源的辐射范围做一个判断,如果当前的Fragment不在范围内,<br>就不去计算</p>
<h3 id="Threshold-边界"><a href="#Threshold-边界" class="headerlink" title="Threshold 边界"></a>Threshold 边界</h3><p>问题:对于每个光源,如果距离计算衰减到光照为0就表示不用去计算的话,就不会找到边界了。</p>
<p>想法:我们可以设置一个阈值,用如下公式计算距离d,如果大于d的就忽略掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820183016882.png" alt="image-20240820183016882"></p>
<p>延迟渲染它本身并不能支持非常大量的光源，因为我们仍然必须要对场景中每一个光源计算每一个片段的光照分量。真正让大量光源成为可能的是我们能够对延迟渲染管线引用的一个非常棒的优化：<strong>光体积(Light Volumes)</strong> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820180819761.png" alt="image-20240820180819761" style="zoom:67%;" />

<p>得出X即为D的阈值</p>
<h3 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820183328522.png" alt="image-20240820183328522" style="zoom:67%;" />

<p>GPU再运行if的时候 并行执行 会造成性能丢失</p>
<h4 id="优化-1"><a href="#优化-1" class="headerlink" title="优化"></a>优化</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_image/image-20240820183651077.png" alt="image-20240820183651077" style="zoom:67%;" />

<p>将所有的几何信息写在G-Buffer上面,也就是说我们可以为每一个光照做一个球,然后使用G-Buffer的信息作为绑定纹理, 只渲染每一个光照球,这个球体Fragment范围内的G-Buffer才会被渲染</p>
<h3 id="光源重合问题"><a href="#光源重合问题" class="headerlink" title="光源重合问题"></a>光源重合问题</h3><p>使用Blend功能,设置混合模式,比如我们可以设置对物体影响最强的光源为主</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glBlendFuncSeparate</span>(GL_ONE, GL ONE, GL_ONE, GL_ONE);</span><br><span class="line"><span class="built_in">glBlendEquation</span>(GL_MAX);</span><br></pre></td></tr></table></figure>

<p>也可以采用相加方式</p>
<h3 id="CullFace问题"><a href="#CullFace问题" class="headerlink" title="CullFace问题"></a>CullFace问题</h3><p>球体存在正反两面 所以会被绘制两次 增大了负担 CullFace会导致进入球体内部不存在渲染</p>
<p>开启glCullFace(GL_FRONT) 绘制效率,且可以进入球体内部 只对球体背面进行绘制,这样提高了一倍的</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_imageava.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_imageava.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Edmend Zhang</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/')">OpenGL Advance</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=OpenGL Advance&amp;url=http://example.com/2025/08/18/graphics/opengl/OpenGL%20Advance/&amp;pic=https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/4d7108d8db204bfbaabe41ffc07cf1cd.png?_r_=fba0f37a-4bbe-3123-e309-13693001d871" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/OpenGL/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>OpenGL<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/Graphics/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Graphics<span class="tagsPageCount">12</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-g8gx1l.png?_r_=1120b6bf-7c4b-bf66-7ac0-13536c7e7b97" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/08/18/graphics/Directx12/PSO/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-34xkv0.jpg?_r_=9beebfd5-2999-8c75-56bb-2cee84f47ea0" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2025/08/18/graphics/Games202/Introduction/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-g8gx1l.png?_r_=1120b6bf-7c4b-bf66-7ac0-13536c7e7b97" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info"></div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/08/02/graphics/opengl/Opengl/" title="OpenGL"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/Photo%20by%20Alberto%20Restifo%20%28Ni4NgA64TFQ%29.jpg?_r_=97a5d9af-69b7-4ea7-f2fd-3b5b8a3a2f60" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-02</div><div class="title">OpenGL</div></div></a></div><div><a href="/2025/08/18/VideoAudioDev/OPENGL%20%E5%92%8C%20FFMPEG%20%E5%AE%9E%E7%8E%B0%E5%85%A8%E6%99%AF%E6%92%AD%E6%94%BE%E5%99%A8/" title="OPENGL + FFMPEG 实现全景播放器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/Photo%20by%20Aaron%20Burden%20%28MSRRAkkLi9U%29.jpg?_r_=31d173bd-c114-d5bb-acdf-a2be6bc5f66e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-18</div><div class="title">OPENGL + FFMPEG 实现全景播放器</div></div></a></div><div><a href="/2024/07/30/graphics/Games101/Games%20101%20Geometry/" title="Geometry"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/51166367_p0_master1200.jpeg?_r_=d83f0752-4516-49f2-a8d9-f93b19acfe5b" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-30</div><div class="title">Geometry</div></div></a></div><div><a href="/2024/07/29/graphics/Games101/Games%20101%20Homework/" title="Homework"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-wyrqg7.png?_r_=667b8698-e70b-9a73-040f-2a65934e30fd" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-29</div><div class="title">Homework</div></div></a></div><div><a href="/2024/07/28/graphics/Games101/Games%20101%20Illumination%EF%BC%8CShading%20and%20Graphics%20Pipeline/" title="Illumination，Shading and Graphics Pipeline"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/Photo%20by%20Alessio%20Furlan%20%281_w81R7vBDs%29.jpg?_r_=20131443-7a61-309c-7acd-626533d0d9c7" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-28</div><div class="title">Illumination，Shading and Graphics Pipeline</div></div></a></div><div><a href="/2024/07/27/graphics/Games101/Games%20101%20Materials%20and%20Appearances/" title="Materials and Appearances"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/Photo%20by%20Alessandro%20Erbetta%20%28mpWPcRT9D1E%29.jpg?_r_=21ca28e7-97cb-c0ec-3a40-a194dfa61d91" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-27</div><div class="title">Materials and Appearances</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> Comment</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/blog_imageava.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>Announcement</span></div><div class="announcement_content">欢迎~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenGL-Advance"><span class="toc-number">1.</span> <span class="toc-text">OpenGL Advance</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">深度测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%80%BC%E6%8E%A8%E5%AF%BC"><span class="toc-number">1.1.1.</span> <span class="toc-text">深度值推导</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E7%BC%93%E5%AD%98"><span class="toc-number">1.1.2.</span> <span class="toc-text">模板缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%85%89%E8%BE%B9%E7%BC%98%EF%BC%88%E9%80%89%E4%B8%AD%E6%95%88%E6%9E%9C%EF%BC%89%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">高光边缘（选中效果）原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Blending-%E6%95%88%E6%9E%9C"><span class="toc-number">1.2.</span> <span class="toc-text">Blending 效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">透明的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.2.</span> <span class="toc-text">接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E8%AE%A1%E7%AE%97%E5%87%BA%E6%BA%90%E9%A2%9C%E8%89%B2%E4%B8%8E%E7%9B%AE%E6%A0%87%E9%A2%9C%E8%89%B2"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">第一步,计算出源颜色与目标颜色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E8%AE%BE%E7%BD%AE%E8%AE%A1%E7%AE%97%E5%90%8E%E7%9A%84SRC%E9%A2%9C%E8%89%B2%E4%B8%8EDST%E9%A2%9C%E8%89%B2%E4%B9%8B%E9%97%B4%E7%9A%84%E8%AE%A1%E7%AE%97%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">第二步,设置计算后的SRC颜色与DST颜色之间的计算方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cullFace%E8%A1%A8%E9%9D%A2%E5%89%94%E9%99%A4"><span class="toc-number">1.3.</span> <span class="toc-text">cullFace表面剔除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E9%9D%A2%E7%9A%84%E9%A1%B6%E7%82%B9%E7%BB%98%E5%88%B6%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.3.1.</span> <span class="toc-text">定义面的顶点绘制顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FramBuffer-%E5%B8%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.</span> <span class="toc-text">FramBuffer 帧缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B8%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.1.</span> <span class="toc-text">创建帧缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%88%99"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">原则:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Texture-%E4%BD%9C%E4%B8%BABuffer%E9%99%84%E4%BB%B6ColorBuffer"><span class="toc-number">1.4.2.</span> <span class="toc-text">Texture 作为Buffer附件ColorBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RenderBuffer%E4%BD%9C%E4%B8%BABuffer%E9%99%84%E4%BB%B6ColorBuffer"><span class="toc-number">1.4.3.</span> <span class="toc-text">RenderBuffer作为Buffer附件ColorBuffer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BARenderBuffer"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">创建RenderBuffer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FrameBuffer-%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.4.</span> <span class="toc-text">FrameBuffer 渲染流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CubeMap"><span class="toc-number">1.5.</span> <span class="toc-text">CubeMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CubeMap%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.5.1.</span> <span class="toc-text">CubeMap接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A9%E7%A9%BA%E7%9B%92%E7%90%86%E8%AE%BA"><span class="toc-number">1.5.2.</span> <span class="toc-text">天空盒理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A9%E7%A9%BA%E7%9B%92Shader%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.3.</span> <span class="toc-text">天空盒Shader解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VertexShader"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">VertexShader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FragmentShader"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">FragmentShader</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A9%E7%A9%BA%E7%9B%92%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.</span> <span class="toc-text">天空盒优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">问题:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">优化:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E8%B4%B4%E5%9B%BE"><span class="toc-number">1.6.</span> <span class="toc-text">环境贴图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shader"><span class="toc-number">1.6.2.</span> <span class="toc-text">Shader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%98%E5%B0%84"><span class="toc-number">1.6.3.</span> <span class="toc-text">折射</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.7.</span> <span class="toc-text">数据接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E7%82%B9%E6%95%B0%E6%8D%AE%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.7.1.</span> <span class="toc-text">定点数据拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#glMapBuffer-%E8%99%9A%E6%8B%9F%E6%8C%87%E9%92%88"><span class="toc-number">1.7.2.</span> <span class="toc-text">glMapBuffer 虚拟指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E7%82%B9%E6%95%B0%E6%8D%AE%E6%89%93%E5%8C%85%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.3.</span> <span class="toc-text">顶点数据打包方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#buffer%E4%B9%8B%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.7.4.</span> <span class="toc-text">buffer之间的数据拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="toc-number">1.7.5.</span> <span class="toc-text">内置变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%95%B0%E6%8D%AE%E5%9D%97-Blocks"><span class="toc-number">1.7.6.</span> <span class="toc-text">接口数据块 Blocks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UniformBlock-%E6%98%BE%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">1.8.</span> <span class="toc-text">UniformBlock 显存分配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%95%B0%E6%8D%AE%E5%9D%97-Uniform-Buffer-Object"><span class="toc-number">1.8.1.</span> <span class="toc-text">全局数据块 Uniform Buffer Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared-%E9%BB%98%E8%AE%A4%E6%96%B9%E5%BC%8F"><span class="toc-number">1.8.2.</span> <span class="toc-text">**shared 默认方式 **</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#std140"><span class="toc-number">1.8.3.</span> <span class="toc-text">std140</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UBO-%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.4.</span> <span class="toc-text">UBO 生成过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-code-%E7%9C%81%E7%95%A5%E5%90%8E"><span class="toc-number">1.8.5.</span> <span class="toc-text">core code 省略后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GeometryShader-%E5%87%A0%E4%BD%95%E7%9D%80%E8%89%B2%E5%99%A8"><span class="toc-number">1.9.</span> <span class="toc-text">GeometryShader 几何着色器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%A0%E4%BD%95%E7%9D%80%E8%89%B2%E5%99%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.9.1.</span> <span class="toc-text">几何着色器原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E8%BE%93%E5%85%A5"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">点输入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E8%A7%92%E5%BD%A2%E8%BE%93%E5%85%A5"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">三角形输入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Geometry-%E8%BE%93%E5%87%BA-%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B9%89%E4%BA%86%E5%9B%BE%E5%85%83%E8%A3%85%E9%85%8D%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">Geometry 输出 重新定义了图元装配的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GeometryShader"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">GeometryShader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gl-in"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">gl_in</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%95%E5%90%91%E9%87%8F%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">1.9.2.</span> <span class="toc-text">法向量可视化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VertexShader-1"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">VertexShader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GeometryShader-1"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">GeometryShader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%AF%BB%E5%8F%96"><span class="toc-number">1.10.</span> <span class="toc-text">模型读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E6%9D%90%E8%B4%A8"><span class="toc-number">1.10.1.</span> <span class="toc-text">模型材质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assimp%E5%BA%93%EF%BC%88%E8%AF%BB%E5%8F%96%EF%BC%89"><span class="toc-number">1.10.2.</span> <span class="toc-text">Assimp库（读取）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Scene"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">Scene</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Child-node"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">Child node</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mesh"><span class="toc-number">1.10.3.</span> <span class="toc-text">Mesh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DrawCall-%E5%87%8F%E5%B0%91%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80"><span class="toc-number">1.10.4.</span> <span class="toc-text">DrawCall 减少性能开销</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gl-InstanceID-%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">gl_InstanceID 内置变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gl-InstanceID-%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F-%E4%BC%98%E5%8C%96-InstanceArray"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">gl_InstanceID 内置变量 优化 InstanceArray</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#glVertexAttribDivisor-GLuint-index-GLuint-divisor"><span class="toc-number">1.10.4.3.</span> <span class="toc-text">glVertexAttribDivisor(GLuint index, GLuint divisor)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instance-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.5.</span> <span class="toc-text">Instance 实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Blin-Phong-%E5%85%89%E7%85%A7%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.</span> <span class="toc-text">Blin-Phong 光照实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E7%A8%8B%E5%90%91%E9%87%8F"><span class="toc-number">1.11.1.</span> <span class="toc-text">半程向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C"><span class="toc-number">1.11.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gamma%E7%9F%AB%E6%AD%A3"><span class="toc-number">1.12.</span> <span class="toc-text">Gamma矫正</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%99%A8%E4%BA%AE%E5%BA%A6%E4%B8%8E%E7%94%B5%E5%8E%8B%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.12.1.</span> <span class="toc-text">显示器亮度与电压的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SRGB%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4"><span class="toc-number">1.12.2.</span> <span class="toc-text">SRGB颜色空间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ShadowMapping"><span class="toc-number">1.13.</span> <span class="toc-text">ShadowMapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E8%A1%8C%E5%85%89"><span class="toc-number">1.13.1.</span> <span class="toc-text">平行光</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E6%B8%B2%E6%9F%93-FrameBuffer"><span class="toc-number">1.13.2.</span> <span class="toc-text">深度渲染 FrameBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FragmentShader-%E9%98%B4%E5%BD%B1%E9%83%A8%E5%88%86%EF%BC%88Pass2%EF%BC%89"><span class="toc-number">1.13.3.</span> <span class="toc-text">FragmentShader 阴影部分（Pass2）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C"><span class="toc-number">1.13.4.</span> <span class="toc-text">实际效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShadowAnce-%E5%99%AA%E5%A3%B0-%EF%BC%88%E9%87%87%E6%A0%B7%E4%B8%8D%E5%9D%87%E9%97%AE%E9%A2%98%EF%BC%89"><span class="toc-number">1.13.5.</span> <span class="toc-text">ShadowAnce 噪声 （采样不均问题）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bias%E5%8F%82%E6%95%B0%E5%8E%BB%E5%99%AA"><span class="toc-number">1.13.6.</span> <span class="toc-text">Bias参数去噪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Peter-Panning-%E5%8E%BB%E5%99%AA"><span class="toc-number">1.13.7.</span> <span class="toc-text">Peter Panning 去噪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E9%87%87%E6%A0%B7%E9%97%AE%E9%A2%98"><span class="toc-number">1.13.8.</span> <span class="toc-text">过采样问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B4%E5%BD%B1%E9%94%AF%E9%BD%BF%E9%97%AE%E9%A2%98"><span class="toc-number">1.13.9.</span> <span class="toc-text">阴影锯齿问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PCF-percentage-closer-filtering"><span class="toc-number">1.13.10.</span> <span class="toc-text">PCF-percentage-closer filtering</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PointShadow"><span class="toc-number">1.14.</span> <span class="toc-text">PointShadow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="toc-number">1.14.1.</span> <span class="toc-text">优化思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B4%E5%BD%B1%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.14.2.</span> <span class="toc-text">阴影渲染流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CubeMap%E5%9D%90%E6%A0%87%E5%8E%9F%E7%90%86"><span class="toc-number">1.15.</span> <span class="toc-text">CubeMap坐标原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE-TBN%E7%A9%BA%E9%97%B4%E6%8E%A8%E5%AF%BC"><span class="toc-number">1.16.</span> <span class="toc-text">法线贴图 &amp; TBN空间推导</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TBN-%E7%A9%BA%E9%97%B4%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.16.1.</span> <span class="toc-text">TBN 空间转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HDR%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4"><span class="toc-number">1.17.</span> <span class="toc-text">HDR颜色空间</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HDR-FloatingPoint-Buffers"><span class="toc-number">1.17.1.</span> <span class="toc-text">HDR-FloatingPoint Buffers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDR-toneMapping"><span class="toc-number">1.17.2.</span> <span class="toc-text">HDR toneMapping</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Reinhard-tone-mapping"><span class="toc-number">1.17.2.1.</span> <span class="toc-text">Reinhard tone mapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exposure-tone-mapping"><span class="toc-number">1.17.2.2.</span> <span class="toc-text">Exposure tone mapping</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bloom-%E6%95%88%E6%9E%9C"><span class="toc-number">1.18.</span> <span class="toc-text">Bloom 效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bloom-%E5%9F%BA%E7%A1%80%E5%81%9A%E6%B3%95"><span class="toc-number">1.18.1.</span> <span class="toc-text">Bloom 基础做法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%89%E6%BA%90%E8%BE%B9%E7%95%8C%E9%97%AE%E9%A2%98%E7%95%8C%E5%AE%9A"><span class="toc-number">1.18.2.</span> <span class="toc-text">光源边界问题界定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRT%E6%8A%80%E6%9C%AF"><span class="toc-number">1.18.3.</span> <span class="toc-text">MRT技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-1"><span class="toc-number">1.18.4.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A"><span class="toc-number">1.19.</span> <span class="toc-text">高斯模糊</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E6%96%AF-Shader"><span class="toc-number">1.19.1.</span> <span class="toc-text">高斯 Shader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93%E6%8A%80%E6%9C%AF"><span class="toc-number">1.20.</span> <span class="toc-text">延迟渲染技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#G%E7%BC%93%E5%86%B2"><span class="toc-number">1.20.1.</span> <span class="toc-text">G缓冲</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E6%B8%B2%E6%9F%93%E4%B8%AD%E7%85%A7%E4%BA%AE%E4%B8%80%E4%B8%AA%E7%89%87%E6%AE%B5%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">1.20.1.1.</span> <span class="toc-text">正向渲染中照亮一个片段所需要的所有数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E5%85%89%E7%85%A7%E5%A4%84%E7%90%86"><span class="toc-number">1.20.2.</span> <span class="toc-text">延迟光照处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Shader-1"><span class="toc-number">1.20.2.1.</span> <span class="toc-text">Shader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E5%90%88%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93%E4%B8%8E%E6%AD%A3%E5%90%91%E6%B8%B2%E6%9F%93"><span class="toc-number">1.21.</span> <span class="toc-text">结合延迟渲染与正向渲染</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E7%9A%84%E4%BD%93%E7%A7%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">1.22.</span> <span class="toc-text">光的体积渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Threshold-%E8%BE%B9%E7%95%8C"><span class="toc-number">1.22.1.</span> <span class="toc-text">Threshold 边界</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B"><span class="toc-number">1.22.2.</span> <span class="toc-text">程序流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96-1"><span class="toc-number">1.22.2.1.</span> <span class="toc-text">优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%89%E6%BA%90%E9%87%8D%E5%90%88%E9%97%AE%E9%A2%98"><span class="toc-number">1.22.3.</span> <span class="toc-text">光源重合问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CullFace%E9%97%AE%E9%A2%98"><span class="toc-number">1.22.4.</span> <span class="toc-text">CullFace问题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/graphics/Games202/Introduction/" title="No title"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-g8gx1l.png?_r_=1120b6bf-7c4b-bf66-7ac0-13536c7e7b97" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2025/08/18/graphics/Games202/Introduction/" title="No title">No title</a><time datetime="2025-08-18T06:52:24.917Z" title="Created 2025-08-18 06:52:24">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/graphics/opengl/OpenGL%20Advance/" title="OpenGL Advance"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/4d7108d8db204bfbaabe41ffc07cf1cd.png?_r_=fba0f37a-4bbe-3123-e309-13693001d871" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenGL Advance"/></a><div class="content"><a class="title" href="/2025/08/18/graphics/opengl/OpenGL%20Advance/" title="OpenGL Advance">OpenGL Advance</a><time datetime="2025-08-18T06:52:24.917Z" title="Created 2025-08-18 06:52:24">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/graphics/Directx12/PSO/" title="No title"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-34xkv0.jpg?_r_=9beebfd5-2999-8c75-56bb-2cee84f47ea0" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2025/08/18/graphics/Directx12/PSO/" title="No title">No title</a><time datetime="2025-08-18T06:52:24.916Z" title="Created 2025-08-18 06:52:24">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/graphics/Games104/1%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%B1%82/" title="No title"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/Photo%20by%20Adam%20Przeniewski%20%28DgXiyrNE8FU%29.jpg?_r_=79d70a3d-c28f-4a90-8ec6-20775d4dc518" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2025/08/18/graphics/Games104/1%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%B1%82/" title="No title">No title</a><time datetime="2025-08-18T06:52:24.916Z" title="Created 2025-08-18 06:52:24">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/Unreal/UE%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="No title"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhardzhangblog.oss-us-west-1.aliyuncs.com/cover_top_image/20240816/wallhaven-oxlo85.jpg?_r_=bbda57bd-cef2-9a60-2e46-f7c596a31f83" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2025/08/18/Unreal/UE%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="No title">No title</a><time datetime="2025-08-18T06:52:24.915Z" title="Created 2025-08-18 06:52:24">2025-08-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Edmend Zhang" target="_blank">Edmend Zhang</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">Articles</div><div class="length-num">46</div></a><a href="/tags/" title="tag"><div class="headline">Tags</div><div class="length-num">27</div></a><a href="/categories/" title="category"><div class="headline">Categories</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="Display Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>Display Mode</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.tryhardzhang.xyz/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.tryhardzhang.xyz/" title="none"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="none"/><span class="back-menu-item-text">none</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 想法</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=9570676565&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CPP/" style="font-size: 0.88rem;">CPP<sup>2</sup></a><a href="/tags/CSEN-279/" style="font-size: 0.88rem;">CSEN 279<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>2</sup></a><a href="/tags/FFMPEG/" style="font-size: 0.88rem;">FFMPEG<sup>3</sup></a><a href="/tags/Frigate/" style="font-size: 0.88rem;">Frigate<sup>1</sup></a><a href="/tags/Games101/" style="font-size: 0.88rem;">Games101<sup>9</sup></a><a href="/tags/Graphics/" style="font-size: 0.88rem;">Graphics<sup>12</sup></a><a href="/tags/Home-Assistant/" style="font-size: 0.88rem;">Home Assistant<sup>1</sup></a><a href="/tags/HomeAssistant/" style="font-size: 0.88rem;">HomeAssistant<sup>1</sup></a><a href="/tags/Interview-Question/" style="font-size: 0.88rem;">Interview Question<sup>1</sup></a><a href="/tags/OpenGL/" style="font-size: 0.88rem;">OpenGL<sup>3</sup></a><a href="/tags/RTMP/" style="font-size: 0.88rem;">RTMP<sup>1</sup></a><a href="/tags/RTP/" style="font-size: 0.88rem;">RTP<sup>1</sup></a><a href="/tags/RTSP/" style="font-size: 0.88rem;">RTSP<sup>4</sup></a><a href="/tags/SDL/" style="font-size: 0.88rem;">SDL<sup>1</sup></a><a href="/tags/UE5/" style="font-size: 0.88rem;">UE5<sup>3</sup></a><a href="/tags/VCPKG/" style="font-size: 0.88rem;">VCPKG<sup>1</sup></a><a href="/tags/csen-272/" style="font-size: 0.88rem;">csen 272<sup>2</sup></a><a href="/tags/live555/" style="font-size: 0.88rem;">live555<sup>1</sup></a><a href="/tags/nlp/" style="font-size: 0.88rem;">nlp<sup>2</sup></a><a href="/tags/search/" style="font-size: 0.88rem;">search<sup>2</sup></a><a href="/tags/%E5%85%A8%E6%99%AF%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 0.88rem;">全景播放器<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 0.88rem;">博客<sup>1</sup></a><a href="/tags/%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 0.88rem;">播放器<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 0.88rem;">虚拟机<sup>1</sup></a><a href="/tags/%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 0.88rem;">视频播放器<sup>1</sup></a><a href="/tags/%E8%A7%86%E9%A2%91%E6%B5%81%E4%BC%A0%E8%BE%93/" style="font-size: 0.88rem;">视频流传输<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="9570676565" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=9570676565&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Edmend Zhang 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://tryhardzhang.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://tryhardzhang.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://tryhardzhang.netlify.app/.netlify/functions/twikoo',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "Unable to get the data, please make sure the settings are correct."
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>